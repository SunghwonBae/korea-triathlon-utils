<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triathlon Total Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        .record-card { transition: all 0.2s; }
        .record-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .source-badge-ironman { background-color: #ef4444; color: white; }
        .source-badge-challenge { background-color: #f59e0b; color: white; }
        .source-badge-triathlon { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-person-running"></i> IRON SEARCH
            </h1>
            <div class="relative group">
                <button onclick="window.location.href='memory_report.html'" class="text-sm bg-slate-700 px-3 py-1 rounded hover:bg-slate-600 transition">
                    <i class="fa-solid fa-chart-pie mr-1"></i> 분석실로 이동
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 mt-6">
        
        <div class="text-center mb-8">
            <h2 class="text-2xl font-bold mb-2">선수 통합 검색</h2>
            <p class="text-slate-500 text-sm mb-6">아이언맨, 챌린지, 협회 대회를 한 번에 검색하세요.</p>
            
            <div class="relative max-w-lg mx-auto">
                <input type="text" id="searchInput" 
                    class="w-full p-4 pl-12 rounded-full border border-slate-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-500 text-lg"
                    placeholder="이름 (홍길동, Hong) 또는 배번호 검색...">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400 text-xl"></i>
            </div>
            <div class="mt-2 text-xs text-slate-400">
                * 동명이인이 있을 수 있으니 기록을 확인하고 [담기] 하세요.
            </div>
        </div>

        <div id="memoryBar" class="hidden fixed bottom-6 right-6 bg-slate-800 text-white p-4 rounded-lg shadow-2xl z-40 max-w-xs animate-bounce-in">
            <div class="flex justify-between items-center mb-2">
                <span class="font-bold"><i class="fa-solid fa-basket-shopping mr-2"></i>T-Memory</span>
                <span id="memoryCount" class="bg-red-500 text-xs px-2 py-0.5 rounded-full">0</span>
            </div>
            <p class="text-xs text-slate-300 mb-3">선택한 기록이 저장되었습니다.</p>
            <button onclick="saveAndGo()" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-sm py-2 rounded transition">
                분석 하러가기
            </button>
        </div>

        <div id="resultsArea" class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
            <div class="col-span-full text-center text-slate-400 py-10">
                검색어를 입력하면 전체 대회 기록이 나타납니다.
            </div>
        </div>

    </main>

    <script>
        let allData = [];
        let memory = JSON.parse(localStorage.getItem('triathlon_memory') || '[]');

        // 1. 데이터 로드 (빌드된 통합 JSON)
        async function loadData() {
            try {
                const res = await fetch('/data/all_records.json');
                allData = await res.json();
                console.log(`Data Loaded: ${allData.length} records`);
                updateMemoryUI();
            } catch (e) {
                console.error("데이터 로드 실패:", e);
                document.getElementById('resultsArea').innerHTML = `<div class="p-4 bg-red-100 text-red-600 rounded">데이터 파일을 찾을 수 없습니다. (build script 실행 필요)</div>`;
            }
        }

        // 2. 검색 로직 (초성 검색 포함)
        const CHO_HANGUL = [
            'ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'
        ];
        
        function getKoreanRegex(searchStr) {
            let regexStr = "";
            for (let char of searchStr) {
                if (/[가-힣]/.test(char)) {
                    regexStr += char; // 완성형 한글은 그대로
                } else if (/[ㄱ-ㅎ]/.test(char)) {
                    // 초성 처리
                    const choIndex = CHO_HANGUL.indexOf(char);
                    if (choIndex > -1) {
                        const begin = 0xAC00 + (choIndex * 588);
                        const end = begin + 587;
                        regexStr += `[${char}\\u${begin.toString(16)}-\\u${end.toString(16)}]`;
                    } else {
                        regexStr += char;
                    }
                } else {
                    regexStr += char; // 영어/숫자 등
                }
            }
            return new RegExp(regexStr, 'i'); // case-insensitive
        }

        const input = document.getElementById('searchInput');
        input.addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (val.length < 2) {
                document.getElementById('resultsArea').innerHTML = '<div class="col-span-full text-center text-slate-400 py-10">2글자 이상 입력해주세요.</div>';
                return;
            }
            
            // 검색 실행
            // 1. 영어 이름 매칭 (Romanization logic or simple substring)
            // 2. 한글 이름/초성 매칭
            // 3. 배번호 매칭
            
            const regex = getKoreanRegex(val);
            const isEnglish = /^[A-Za-z\s]+$/.test(val);
            
            const filtered = allData.filter(item => {
                // 통합 SearchKey 활용
                if (regex.test(item.n)) return true; // 한글 이름 매칭
                if (item.n && item.n.toLowerCase().includes(val.toLowerCase())) return true; // 영어 이름 매칭
                if (item.b== val) return true; // 배번호 일치
                
                // (추가) 영어로 쳤는데 한글이름 발음검색? 
                // 이는 복잡하므로 여기선 영문 이름 필드가 있는 경우만 매칭
                return false;
            });

            renderResults(filtered);
        });

        // 3. 렌더링
        function renderResults(list) {
            const area = document.getElementById('resultsArea');
            if (list.length === 0) {
                area.innerHTML = '<div class="col-span-full text-center text-slate-500 py-10">검색 결과가 없습니다.</div>';
                return;
            }

            area.innerHTML = list.map(item => {
                const isSaved = memory.some(m => m.savedAt && m.raceName === item.raceName && m.b === item.b); // 간단한 중복 체크
                
                // 뱃지 색상
                let badgeClass = 'bg-gray-500';
                if(item.source === 'ironman') badgeClass = 'source-badge-ironman';
                else if(item.source === 'challenge') badgeClass = 'source-badge-challenge';
                else if(item.source === 'triathlon') badgeClass = 'source-badge-triathlon';

                // 시간 포맷
                const totalTime = item.t || "DNF";
                
                // 상세 기록 문자열
                let details = "";
                
                if(typeof item.s === 'number') {
                        // 초 단위인 경우 변환 로직 필요하나 build script에서 이미 변환 추천. 
                        // 여기서는 텍스트 그대로 출력 (Build script가 잘 처리했다고 가정)
                        details = `S: ${formatSec(item.s)} / B: ${formatSec(item.bk)} / R: ${formatSec(item.rn)}`;
                } else {
                    // 이미 텍스트인 경우
                    details = `S: ${item.s || '-'} / B: ${item.bk || '-'} / R: ${item.rn || '-'}`;
                }
                

                return `
                <div class="record-card bg-white p-4 rounded-lg shadow border border-slate-100 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs font-bold px-2 py-1 rounded ${badgeClass} mb-1 inline-block uppercase">${item.source}</span>
                            <h3 class="font-bold text-lg text-slate-800">
                                ${item.n} 
                                <span class="text-sm text-slate-400 font-normal">${item.n}</span>
                            </h3>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-slate-700">${formatSec(totalTime)}</div>
                            <div class="text-xs text-slate-400">Rank: ${item.ra || '-'}</div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-slate-600 mb-2">
                        <div class="font-medium">${item.raceName}</div>
                        <div class="text-xs text-slate-400">${item.raceYear} | Bib: ${item.b} | ${item.d}</div>
                    </div>

                    <div class="bg-slate-50 p-2 rounded text-xs text-slate-500 font-mono mb-3 text-center">
                        ${details}
                    </div>
                    
                    <button onclick='toggleMemory(${JSON.stringify(item).replace(/'/g, "&#39;")})' 
                        class="w-full py-2 rounded text-sm font-bold transition ${isSaved ? 'bg-slate-200 text-slate-500 cursor-not-allowed' : 'bg-slate-900 text-white hover:bg-slate-700'}">
                        ${isSaved ? '<i class="fa-solid fa-check"></i> 저장됨' : '<i class="fa-solid fa-plus"></i> T-Memory 담기'}
                    </button>
                </div>
                `;
            }).join('');
        }

        // Helper: 초 -> MM:SS (화면 표시용 단순화)
        function formatSec(val) {
            if(!val) return "-";
            if(String(val).includes(":")) return val; // 이미 텍스트면 패스
            const num = parseInt(val);
            if(isNaN(num)) return val;
            const h = Math.floor(num/3600);
            const m = Math.floor((num%3600)/60);
            return h > 0 ? `${h}h ${m}m` : `${m}m`;
        }

        // 4. T-Memory 기능
        window.toggleMemory = function(item) {
            // 이미 있는지 확인
            const existsIdx = memory.findIndex(m => m.raceName === item.raceName && m.bib === item.b);
            
            if (existsIdx > -1) {
                // 이미 있으면 삭제? 아니면 유지? 기획에 따라 다름. 여기선 중복 방지 알림.
                alert("이미 담겨있는 기록입니다.");
                return;
            }

            const sameTypeItems = memory.filter(m => m.raceType === item.raceType);
            const maxOrder = sameTypeItems.length > 0 ? Math.max(...sameTypeItems.map(m => m.sortOrder || 0)) : 0;
            const sortOrder = maxOrder + 1;

            const memoryItem = {
                ...item,
                sortOrder: sortOrder,
                savedAt: new Date().toISOString()
            };

            memory.push(memoryItem);
            localStorage.setItem('triathlon_memory', JSON.stringify(memory));
            updateMemoryUI();
            
            // 버튼 상태 업데이트를 위해 리렌더링은 비효율적이므로 버튼만 바꿀 수도 있지만, 
            // 여기선 input 이벤트를 트리거해서 리렌더링
            input.dispatchEvent(new Event('input'));
        };

        function updateMemoryUI() {
            const bar = document.getElementById('memoryBar');
            const count = document.getElementById('memoryCount');
            count.innerText = memory.length;
            if (memory.length > 0) {
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
            }
        }

        window.saveAndGo = function() {
            window.location.href = 'memory_report.html';
        };

        // 초기화
        loadData();

    </script>
</body>
</html>