<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triathlon Total Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        .record-card { transition: all 0.2s; }
        .record-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .source-badge-ironman { background-color: #ef4444; color: white; }
        .source-badge-challenge { background-color: #f59e0b; color: white; }
        .source-badge-triathlon { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-person-running"></i> IRON SEARCH
            </h1>
            <div class="relative group">
                <button onclick="window.location.href='memory_report.html'" class="text-sm bg-slate-700 px-3 py-1 rounded hover:bg-slate-600 transition">
                    <i class="fa-solid fa-chart-pie mr-1"></i> 분석실로 이동
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 mt-6">
        
        <div class="text-center mb-8">
            <h2 class="text-2xl font-bold mb-2">선수 통합 검색</h2>
            <p class="text-slate-500 text-sm mb-6">아이언맨, 챌린지, 협회 대회를 한 번에 검색하세요.</p>
            
            <!-- Filter Section -->
            <div class="max-w-lg mx-auto mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-left">
                <label class="block text-xs font-bold text-slate-500 mb-2">1. 대회 타입 선택</label>
                <div id="typeToggles" class="flex gap-2 mb-4 justify-center flex-wrap">
                    <span class="text-sm text-slate-400">데이터 로딩중...</span>
                </div>

                <div id="raceSelectArea" class="hidden transition-all duration-300">
                    <label class="block text-xs font-bold text-slate-500 mb-2">2. 대회 선택 (최대 3개, 다중선택)</label>
                    <select id="raceSelect" multiple class="w-full p-2 border border-slate-300 rounded-lg text-sm h-32 focus:ring-2 focus:ring-slate-500 focus:outline-none"></select>
                    <p class="text-xs text-slate-400 mt-1 text-right">* PC: Ctrl+클릭, 모바일: 터치하여 선택</p>
                </div>
            </div>

            <div class="relative max-w-lg mx-auto">
                <input type="text" id="searchInput" 
                    class="w-full p-4 pl-12 rounded-full border border-slate-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-500 text-lg"
                    placeholder="이름 (홍길동, Hong) 또는 배번호 검색...">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400 text-xl"></i>
            </div>
        </div>



        <div id="resultsArea" class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
            <div class="col-span-full text-center text-slate-400 py-10">
                검색어를 입력하면 전체 대회 기록이 나타납니다.
            </div>
        </div>

        <!-- 그룹 분석 섹션 -->
        <div id="groupAnalysis" class="hidden mt-8 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <h3 class="text-lg font-bold mb-4 text-center">선택된 대회 그룹 분석 (총완주시간 기준 10% 그룹화)</h3>
            <div id="groupTable"></div>
        </div>

    </main>

    <script>
        let allData = [];
        let raceMeta = [];
        let memory = JSON.parse(localStorage.getItem('triathlon_memory') || '[]');
        
        let selectedType = null;
        let selectedRaces = [];

        // 1. 데이터 로드 (빌드된 통합 JSON)
        async function loadData() {
            try {
                const [resRecords, resMeta] = await Promise.all([
                    fetch('/data/all_records.json'),
                    fetch('/data/race_meta.json')
                ]);
                allData = await resRecords.json();
                raceMeta = await resMeta.json();
                console.log(`Data Loaded: ${allData.length} records, ${raceMeta.length} races`);
                initFilterUI();
            } catch (e) {
                console.error("데이터 로드 실패:", e);
                document.getElementById('resultsArea').innerHTML = `<div class="p-4 bg-red-100 text-red-600 rounded">데이터 파일을 찾을 수 없습니다. (build script 실행 필요)</div>`;
            }
        }

        // 2. 검색 로직 (초성 검색 포함)
        const CHO_HANGUL = [
            'ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'
        ];
        
        function getKoreanRegex(searchStr) {
            let regexStr = "";
            for (let char of searchStr) {
                if (/[가-힣]/.test(char)) {
                    regexStr += char; // 완성형 한글은 그대로
                } else if (/[ㄱ-ㅎ]/.test(char)) {
                    // 초성 처리
                    const choIndex = CHO_HANGUL.indexOf(char);
                    if (choIndex > -1) {
                        const begin = 0xAC00 + (choIndex * 588);
                        const end = begin + 587;
                        regexStr += `[${char}\\u${begin.toString(16)}-\\u${end.toString(16)}]`;
                    } else {
                        regexStr += char;
                    }
                } else {
                    regexStr += char; // 영어/숫자 등
                }
            }
            return new RegExp(regexStr, 'i'); // case-insensitive
        }

        // Filter UI Initialization
        function initFilterUI() {
            const types = [...new Set(raceMeta.map(r => r.type))].sort();
            const container = document.getElementById('typeToggles');
            container.innerHTML = types.map(type => `
                <button onclick="toggleType('${type}')" 
                    class="type-btn px-3 py-1.5 rounded-full text-sm font-medium border transition-colors bg-white text-slate-600 border-slate-300 hover:bg-slate-50"
                    data-type="${type}">
                    ${type}
                </button>
            `).join('');
        }

        window.toggleType = function(type) {
            if (selectedType === type) {
                selectedType = null;
                document.getElementById('raceSelectArea').classList.add('hidden');
                selectedRaces = [];
            } else {
                selectedType = type;
                document.getElementById('raceSelectArea').classList.remove('hidden');
                renderRaceOptions(type);
                selectedRaces = [];
            }
            updateTypeButtons();
            doSearch();
        };

        function updateTypeButtons() {
            document.querySelectorAll('.type-btn').forEach(btn => {
                if (btn.dataset.type === selectedType) {
                    btn.className = 'type-btn px-3 py-1.5 rounded-full text-sm font-medium border transition-colors bg-slate-800 text-white border-slate-800 shadow';
                } else {
                    btn.className = 'type-btn px-3 py-1.5 rounded-full text-sm font-medium border transition-colors bg-white text-slate-600 border-slate-300 hover:bg-slate-50';
                }
            });
        }

        function renderRaceOptions(type) {
            const select = document.getElementById('raceSelect');
            const races = raceMeta.filter(r => r.type === type).sort((a,b) => b.year - a.year);
            select.innerHTML = races.map(r => `<option value="${r.name}">${r.name} (${r.participants}명)</option>`).join('');
        }

        document.getElementById('raceSelect').addEventListener('change', (e) => {
            const options = e.target.options;
            const selected = [];
            for(let i=0; i<options.length; i++) {
                if(options[i].selected) selected.push(options[i].value);
            }
            
            if(selected.length > 3) {
                alert("최대 3개까지만 선택 가능합니다.");
                // Enforce limit by deselecting extras
                let count = 0;
                for(let i=0; i<options.length; i++) {
                    if(options[i].selected) {
                        if(count < 3) count++;
                        else options[i].selected = false;
                    }
                }
                // Re-calculate selected
                selected.length = 0;
                for(let i=0; i<options.length; i++) {
                    if(options[i].selected) selected.push(options[i].value);
                }
            }
            selectedRaces = selected;
            doSearch();
        });

        document.getElementById('searchInput').addEventListener('input', doSearch);

        function doSearch() {
            const val = document.getElementById('searchInput').value.trim();
            
            if (val.length < 2 && selectedRaces.length === 0) {
                document.getElementById('resultsArea').innerHTML = '<div class="col-span-full text-center text-slate-400 py-10">검색어를 입력하거나 대회를 선택해주세요.</div>';
                return;
            }
            
            const regex = val.length >= 2 ? getKoreanRegex(val) : null;
            const searchVal = val.toLowerCase().replace(/\s/g, '');
            const isEnglish = /^[A-Za-z\s]+$/.test(val);
            
            const results = [];
            for (let i = 0; i < allData.length; i++) {
                const item = allData[i];
                
                // 1. Race Filter
                if (selectedRaces.length > 0 && !selectedRaces.includes(item.raceName)) continue;

                // 2. Text Filter
                if (val.length >= 2) {
                    let match = false;
                    if ((item.searchKey && item.searchKey.includes(searchVal)) || 
                        (isEnglish && item.n && item.n.toLowerCase().includes(val.toLowerCase())) ||
                        (regex && regex.test(item.n)) ||
                        (item.n && item.n.toLowerCase().includes(val.toLowerCase())) ||
                        (item.c && item.c.toLowerCase().includes(val.toLowerCase()))) {
                        match = true;
                    }
                    if (!match) continue;
                }

                results.push(item);
                if (results.length >= 500) break;
            }
            renderResults(results);
            performGroupAnalysis();
        }

        // 3. 렌더링
        function renderResults(list) {
            const area = document.getElementById('resultsArea');
            if (list.length === 0) {
                area.innerHTML = '<div class="col-span-full text-center text-slate-500 py-10">검색 결과가 없습니다.</div>';
                return;
            }

            area.innerHTML = list.map(item => {
                const isSaved = memory.some(m => m.savedAt && m.raceName === item.raceName && m.b === item.b); // 간단한 중복 체크
                
                // 뱃지 색상
                let badgeClass = 'bg-gray-500';
                if(item.source === 'ironman') badgeClass = 'source-badge-ironman';
                else if(item.source === 'challenge') badgeClass = 'source-badge-challenge';
                else if(item.source === 'triathlon') badgeClass = 'source-badge-triathlon';

                // 시간 포맷
                const totalTime = item.t || "DNF";
                
                // 상세 기록 문자열
                let details = "";
                
                if(typeof item.s === 'number') {
                        // 초 단위인 경우 변환 로직 필요하나 build script에서 이미 변환 추천. 
                        // 여기서는 텍스트 그대로 출력 (Build script가 잘 처리했다고 가정)
                        details = `S: ${formatSec(item.s)} / T1: ${formatSec(item.t1)} / B: ${formatSec(item.bk)} / T2: ${formatSec(item.t2)} / R: ${formatSec(item.rn)}`;
                } else {
                    // 이미 텍스트인 경우
                    details = `S: ${item.s || '-'} / T1: ${item.t || '-'} / B: ${item.bk || '-'} / T2: ${item.t2 || '-'} / R: ${item.rn || '-'}`;
                }
                
                // Meta info lookup
                const meta = raceMeta.find(r => r.name === item.raceName);
                let metaInfo = "";
                if (meta) {
                    metaInfo = `<div class="mt-2 pt-2 border-t border-slate-100 flex justify-between text-[10px] text-slate-400">
                        <span><i class="fa-solid fa-users mr-1"></i>전체 ${meta.participants}명</span>
                        <span><i class="fa-solid fa-stopwatch mr-1"></i>평균 ${formatSec(meta.avgTotal)}</span>
                    </div>`;
                }

                return `
                <div class="record-card bg-white p-4 rounded-lg shadow border border-slate-100 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs font-bold px-2 py-1 rounded ${badgeClass} mb-1 inline-block uppercase">${item.source}</span>
                            <h3 class="font-bold text-lg text-slate-800">
                                ${item.n} 
                                <span class="text-sm text-slate-400 font-normal">${item.c}</span>
                            </h3>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-slate-700">${formatSec(totalTime)}</div>
                            <div class="text-xs text-slate-400">Rank: ${item.ra || '-'}</div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-slate-600 mb-2">
                        <div class="font-medium">${item.raceName}</div>
                        <div class="text-xs text-slate-400">${item.raceYear} | Bib: ${item.b} | ${item.d}</div>
                    </div>

                    <div class="bg-slate-50 p-2 rounded text-xs text-slate-500 font-mono mb-3 text-center">
                        ${details}
                    </div>
                    ${metaInfo}
     
                </div>
                `;
            }).join('');
        }

        // Helper: 초 -> MM:SS (화면 표시용 단순화)
        function formatSec(val) {
            if(!val) return "-";
            if(String(val).includes(":")) return val; // 이미 텍스트면 패스
            const num = parseInt(val);
            if(isNaN(num)) return val;
            const h = Math.floor(num/3600);
            const m = Math.floor((num%3600)/60);
            return h > 0 ? `${h}h ${m}m` : `${m}m`;
        }

        // Helper: 시간 문자열을 초로 변환
        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr === "DNF") return null;
            if (typeof timeStr === 'number') return timeStr;
            const parts = timeStr.split(':');
            if (parts.length === 3) {
                return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
            } else if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
            return null;
        }

        // 그룹 분석 수행
        function performGroupAnalysis() {
            if (selectedRaces.length === 0) {
                document.getElementById('groupAnalysis').classList.add('hidden');
                return;
            }

            // 선택된 대회의 데이터 필터링
            const raceData = allData.filter(item => selectedRaces.includes(item.raceName));

            // 총완주시간으로 정렬 (빠른 순서)
            const sortedData = raceData
                .map(item => ({
                    ...item,
                    totalSec: timeToSeconds(item.t)
                }))
                .filter(item => item.totalSec !== null)
                .sort((a, b) => a.totalSec - b.totalSec);

            if (sortedData.length === 0) {
                document.getElementById('groupAnalysis').classList.add('hidden');
                return;
            }

            // 10%씩 그룹화
            const groupSize = Math.ceil(sortedData.length / 10);
            const groups = [];
            for (let i = 0; i < 10; i++) {
                const start = i * groupSize;
                const end = Math.min((i + 1) * groupSize, sortedData.length);
                const groupData = sortedData.slice(start, end);
                groups.push(groupData);
            }

            // 각 그룹 평균 계산
            const groupAverages = groups.map((group, index) => {
                const count = group.length;
                if (count === 0) return null;

                const avgTotal = group.reduce((sum, item) => sum + item.totalSec, 0) / count;
                const avgSwim = group.reduce((sum, item) => sum + (timeToSeconds(item.s) || 0), 0) / count;
                const avgT1 = group.reduce((sum, item) => sum + (timeToSeconds(item.t1) || 0), 0) / count;
                const avgBike = group.reduce((sum, item) => sum + (timeToSeconds(item.bk) || 0), 0) / count;
                const avgT2 = group.reduce((sum, item) => sum + (timeToSeconds(item.t2) || 0), 0) / count;
                const avgRun = group.reduce((sum, item) => sum + (timeToSeconds(item.rn) || 0), 0) / count;

                return {
                    group: `${index * 10}-${(index + 1) * 10}%`,
                    count,
                    avgTotal: formatSec(Math.round(avgTotal)),
                    avgSwim: formatSec(Math.round(avgSwim)),
                    avgT1: formatSec(Math.round(avgT1)),
                    avgBike: formatSec(Math.round(avgBike)),
                    avgT2: formatSec(Math.round(avgT2)),
                    avgRun: formatSec(Math.round(avgRun))
                };
            }).filter(g => g !== null);

            renderGroupTable(groupAverages);
            document.getElementById('groupAnalysis').classList.remove('hidden');
        }

        // 그룹 테이블 렌더링
        function renderGroupTable(averages) {
            const tableHtml = `
                <table class="w-full border-collapse border border-slate-300 text-sm">
                    <thead>
                        <tr class="bg-slate-100">
                            <th class="border border-slate-300 p-2">그룹</th>
                            <th class="border border-slate-300 p-2">인원</th>
                            <th class="border border-slate-300 p-2">평균 완주시간</th>
                            <th class="border border-slate-300 p-2">평균 수영</th>
                            <th class="border border-slate-300 p-2">평균 T1</th>
                            <th class="border border-slate-300 p-2">평균 싸이클</th>
                            <th class="border border-slate-300 p-2">평균 T2</th>
                            <th class="border border-slate-300 p-2">평균 런</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${averages.map(avg => `
                            <tr class="hover:bg-slate-50">
                                <td class="border border-slate-300 p-2 text-center font-medium">${avg.group}</td>
                                <td class="border border-slate-300 p-2 text-center">${avg.count}</td>
                                <td class="border border-slate-300 p-2 text-center">${avg.avgTotal}</td>
                                <td class="border border-slate-300 p-2 text-center">${avg.avgSwim}</td>
                                <td class="border border-slate-300 p-2 text-center">${avg.avgT1}</td>
                                <td class="border border-slate-300 p-2 text-center">${avg.avgBike}</td>
                                <td class="border border-slate-300 p-2 text-center">${avg.avgT2}</td>
                                <td class="border border-slate-300 p-2 text-center">${avg.avgRun}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('groupTable').innerHTML = tableHtml;
        }



        // 초기화
        loadData();

    </script>
</body>
</html>