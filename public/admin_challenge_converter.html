<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Challenge Gunsan Master Parser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 p-10 text-slate-100">
    <div class="max-w-2xl mx-auto bg-white p-10 rounded-[3rem] shadow-2xl text-slate-800 text-center">
        <h2 class="text-3xl font-black mb-6 text-indigo-600">Challenge Gunsan Parser (22-24)</h2>
        <input type="file" id="pdfInput" class="hidden" />
        <label for="pdfInput" class="block w-full cursor-pointer bg-indigo-600 text-white py-6 rounded-3xl font-bold hover:bg-indigo-700 transition-all shadow-lg">
            PDF 파일 업로드 (모든 연도 통합)
        </label>
        <div id="status" class="mt-4 text-indigo-600 font-bold h-6"></div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        document.getElementById('pdfInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const status = document.getElementById('status');
            status.innerText = "데이터 통합 분석 중...";

            const is2024 = file.name.includes("2024");
            const is2023 = file.name.includes("2023");
            const isHalf = file.name.toLowerCase().includes("half");

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            let results = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                if (is2024) {
                    // --- 2024년: 세로 열(Column) 기반 재조립 로직 ---
                    const cols = { rank: [], bib: [], name: [], club: [], event: [], cat: [], nat: [], gen: [], race: [], s1: [], t1: [], s2: [], t2: [], s3: [], st: [] };
                    
                    textContent.items.forEach(item => {
                        const x = item.transform[4];
                        const str = item.str.trim();
                        if (!str || ["순위","Bib","이름","Club","Event","Category","Nationality","Gender","RaceTime"].includes(str)) return;

                        if (x < 60) cols.rank.push(str);
                        else if (x < 110) cols.bib.push(str);
                        else if (x < 240) cols.name.push(str);
                        else if (x < 400) cols.club.push(str);
                        else if (x < 480) cols.event.push(str);
                        else if (x < 600) cols.cat.push(str);
                        else if (x < 680) cols.nat.push(str);
                        else if (x < 720) cols.gen.push(str);
                        else if (x < 800) cols.race.push(str);
                        else if (x < 880) cols.s1.push(str);
                        else if (x < 940) cols.t1.push(str);
                        else if (x < 1010) cols.s2.push(str);
                        else if (x < 1070) cols.t2.push(str);
                        else if (x < 1150) cols.s3.push(str);
                        else cols.st.push(str);
                    });

                    const maxRows = Math.max(cols.bib.length, cols.name.length);
                    for (let j = 0; j < maxRows; j++) {
                        results.push({
                            year: "2024",
                            PlaceCat: cols.rank[j] || "", Bib: cols.bib[j] || "", 이름: cols.name[j] || "",
                            Club: cols.club[j] || "", Event: cols.event[j] || "", Category: cols.cat[j] || "",
                            nationality: cols.nat[j] || "", gender: cols.gen[j] || "", RaceTime: cols.race[j] || "",
                            Swim: cols.s1[j] || "", T1: cols.t1[j] || "", Bike: cols.s2[j] || "",
                            T2: cols.t2[j] || "", Run: cols.s3[j] || "", status: cols.st[j] || ""
                        });
                    }
                } else {
                    // --- 2022, 2023년: 가로 행(Row) 기반 로직 ---
                    const rows = {};
                    textContent.items.forEach(item => {
                        const y = Math.round(item.transform[5]);
                        if (!rows[y]) rows[y] = [];
                        rows[y].push({ x: item.transform[4], str: item.str.trim() });
                    });

                    Object.keys(rows).sort((a, b) => b - a).forEach(y => {
                        const rowItems = rows[y].sort((a, b) => a.x - b.x);
                        const texts = rowItems.map(r => r.str).filter(s => s !== "");
                        if (texts.length < 5 || !/\d/.test(texts[0])) return;

                        let data = { year: is2023 ? "2023" : "2022" };
                        if (is2023) {
                            const keys23 = isHalf 
                                ? ["Bib", "FirstName", "FamilyName", "이름", "State", "PlaceCat", "RaceTime", "Swim", "T1", "Bike", "T2", "Run", "Start", "swimCheck", "swimEnd", "bikeStart", "bike1Check1", "bike4Check1", "bikeEnd", "runStart", "run2Check1", "run2Check2", "Finish"]
                                : ["Bib", "FirstName", "FamilyName", "이름", "State", "PlaceCat", "RaceTime", "Swim", "T1", "Bike", "T2", "Run", "Start", "swimCheck", "swimEnd", "bikeStart", "bike1Check1", "bike3Check1", "bike4Check1", "bike1Check2", "bike3Check2", "bike4Check2", "bikeEnd", "runStart", "run2Check1", "run1Check1", "run2Check2", "run1Check2", "run2Check3", "run1Check3", "run2Check4", "run1Check4", "Finish"];
                            keys23.forEach((k, idx) => { if(texts[idx]) data[k] = texts[idx]; });
                        } else {
                            const keys22 = ["Bib", "FirstName", "FamilyName", "PlaceCat", "RaceTime", "Swim", "T1", "Bike", "T2", "Run"];
                            keys22.forEach((k, idx) => { if(texts[idx]) data[k] = texts[idx]; });
                        }
                        if (data.Bib) results.push(data);
                    });
                }
            }
            const blob = new Blob([JSON.stringify(results, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${file.name.split('.')[0]}.json`;
            a.click();
            status.innerText = "변환 완료!";
        };
    </script>
</body>
</html>