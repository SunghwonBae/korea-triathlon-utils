<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ë‚ ì§œ ì •ê·œí™” ë“±ë¡</title>
    <style>
        :root { --primary: #0070f3; --bg: #f4f7f6; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 20px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 250px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; font-size: 14px; margin-bottom: 15px; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        #log { margin-top: 20px; padding: 15px; border-radius: 8px; background: #eee; font-size: 13px; max-height: 250px; overflow-y: auto; line-height: 1.6; }
        .success { color: #2ecc71; } .error { color: #e74c3c; font-weight: bold; }

        /* ëª©ë¡ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f8f9fa; font-weight: bold; }
        .actions button { width: auto; padding: 6px 12px; font-size: 13px; margin-right: 5px; border-radius: 6px; }
        .btn-edit { background: #ffc107; color: #333; } .btn-save { background: #28a745; } .btn-delete { background: #dc3545; }
        [contenteditable="true"] { background-color: #fff9c4; outline: 2px solid #0070f3; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ† ëŒ€íšŒ ì¼ì • ì •ê·œí™” ë“±ë¡</h1>
        <p>ì¹´í˜ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ <b>YYYY-MM-DD</b> í˜•ì‹ìœ¼ë¡œ ìë™ ë³€í™˜í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.</p>
        <select id="locationSelector" style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px;">
            <option value="local">êµ­ë‚´ (local)</option>
            <option value="abroad">í•´ì™¸ (abroad)</option>
        </select>
        <textarea id="rawText" placeholder="2026. 3. 29&#10;ì¼&#10;ë‚˜ì£¼ ëŒ€íšŒ..."></textarea>
        <button onclick="processData()">íŒŒì‹± ë° ì •ê·œí™” ì €ì¥ ì‹œì‘</button>
        <div id="log">ì¤€ë¹„ ì™„ë£Œ...</div>
    </div>

    <div class="container">
        <h2>ğŸ“… ë“±ë¡ëœ ëŒ€íšŒ ëª©ë¡</h2>
        <div id="eventListContainer"></div>
    </div>

    <script>
        // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì •ê·œí™”í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
        function normalizeDate(dateStr) {
            // ëª¨ë“  ë§ˆì¹¨í‘œ, ê³µë°±ì„ í•˜ì´í”ˆìœ¼ë¡œ í†µì¼
            let clean = dateStr.replace(/\./g, '-').replace(/\s/g, '');
            let parts = clean.split('-');
            
            if (parts.length === 3) {
                let y = parts[0];
                let m = parts[1].padStart(2, '0'); // '3' -> '03'
                let d = parts[2].padStart(2, '0'); // '5' -> '05'
                return `${y}-${m}-${d}`;
            }
            return dateStr; // í˜•ì‹ì´ ì•ˆ ë§ìœ¼ë©´ ì›ë³¸ ë°˜í™˜
        }

        function addLog(msg, type = '') {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div class="${type}">${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function processData() {
            const text = document.getElementById('rawText').value;
            if(!text.trim()) return alert("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            const whereValue = document.getElementById('locationSelector').value;
            
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = "<b>ë¶„ì„ ë° ì •ê·œí™” ì‹œì‘...</b><br>";
            
            const lines = text.split('\n').map(l => l.trim()).filter(l => l !== "");
            let count = 0;

            for (let i = 0; i < lines.length; i++) {
                // ë‚ ì§œ íŒ¨í„´ ë§¤ì¹­ (2026. 3. 29 ë“±)
                const dateMatch = lines[i].match(/^(\d{4}\.\s?\d{1,2}\.\s?\d{1,2})/);
                
                if (dateMatch) {
                    const originalDate = dateMatch[1];
                    const standardizedDate = normalizeDate(originalDate); // ì •ê·œí™” ì‹¤í–‰
                    const title = lines[i+2]; // ìš”ì¼ ë‹¤ìŒ ì¤„ì´ ëŒ€íšŒëª…

                    if (title && !title.includes('ìš”ì¼')) {
                        try {
                            const res = await fetch('/api/ddays', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    id: title, // í•´ì‹œ í‚¤ë¡œ ì œëª© ì‚¬ìš©
                                    title: title,
                                    startDate: standardizedDate,
                                    type: 'public',
                                    where: whereValue
                                })
                            });
                            if (res.ok) {
                                addLog(`âœ… [${standardizedDate}] ${title}`, 'success');
                                count++;
                            }
                        } catch (err) {
                            addLog(`âŒ ì‹¤íŒ¨: ${title}`, 'error');
                        }
                    }
                }
            }
            addLog(`<br><b>ì´ ${count}ê°œì˜ ëŒ€íšŒê°€ ì •ê·œí™”ë˜ì–´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</b>`);
        }

        // --- ì¶”ê°€ëœ ê¸°ëŠ¥ ---

        // 1. ì´ë²¤íŠ¸ ëª©ë¡ ë¡œë“œ ë° ë Œë”ë§
        async function loadAndRenderEvents() {
            addLog('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...', 'info');
            try {
                const res = await fetch('/api/ddays');
                if (!res.ok) throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                
                const events = await res.json();
                // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬
                events.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

                const container = document.getElementById('eventListContainer');
                if (events.length === 0) {
                    container.innerHTML = '<p>ë“±ë¡ëœ ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ëŒ€íšŒëª…</th>
                                <th>ì§€ì—­</th>
                                <th style="width: 180px;">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                events.forEach(event => {
                    tableHtml += `
                        <tr data-id="${event.id}">
                            <td><span class="data-startDate">${event.startDate}</span></td>
                            <td><span class="data-title">${event.title}</span></td>
                            <td><span class="data-where">${event.where || 'local'}</span></td>
                            <td class="actions">
                                <button class="btn-edit" onclick="toggleEdit(this, '${event.id}')">ìˆ˜ì •</button>
                                <button class="btn-delete" onclick="deleteEvent('${event.id}')">ì‚­ì œ</button>
                            </td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table>';
                container.innerHTML = tableHtml;
                addLog(`${events.length}ê°œì˜ ëŒ€íšŒë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);

            } catch (error) {
                addLog(error.message, 'error');
            }
        }

        // 2. ì´ë²¤íŠ¸ ì‚­ì œ
        async function deleteEvent(id) {
            if (!confirm(`'${id}' ëŒ€íšŒë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            addLog(`'${id}' ì‚­ì œ ì¤‘...`);
            try {
                const res = await fetch(`/api/ddays?id=${encodeURIComponent(id)}`, {
                    method: 'DELETE'
                });
                if (!res.ok) throw new Error('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                
                addLog(`'${id}' ì‚­ì œ ì™„ë£Œ.`, 'success');
                loadAndRenderEvents(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                addLog(error.message, 'error');
            }
        }

        // 3. ìˆ˜ì • ëª¨ë“œ í† ê¸€
        function toggleEdit(btn, id) {
            const row = btn.closest('tr');
            const isEditing = btn.innerText === 'ì €ì¥';

            const titleEl = row.querySelector('.data-title');
            const dateEl = row.querySelector('.data-startDate');
            const whereEl = row.querySelector('.data-where');

            if (isEditing) {
                // ì €ì¥ ë¡œì§ ì‹¤í–‰
                const updatedEvent = {
                    id: id, // ê¸°ì¡´ ID (ë˜ëŠ” title)ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    title: titleEl.innerText.trim(),
                    startDate: dateEl.innerText.trim(),
                    where: whereEl.innerText.trim()
                };
                
                // ë‚ ì§œ í˜•ì‹ ê²€ì‚¬
                if (!/^\d{4}-\d{2}-\d{2}$/.test(updatedEvent.startDate)) {
                    alert('ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                saveEvent(updatedEvent);

            } else {
                // ìˆ˜ì • ëª¨ë“œë¡œ ë³€ê²½
                btn.innerText = 'ì €ì¥';
                btn.classList.remove('btn-edit');
                btn.classList.add('btn-save');

                [titleEl, dateEl, whereEl].forEach(el => {
                    el.contentEditable = true;
                });
                titleEl.focus();
            }
        }

        // 4. ì´ë²¤íŠ¸ ì €ì¥ (ìˆ˜ì •)
        async function saveEvent(eventData) {
            addLog(`'${eventData.id}' ì €ì¥ ì¤‘...`);
            try {
                const res = await fetch('/api/ddays', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });
                if (!res.ok) throw new Error('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                
                addLog(`'${eventData.id}' ì €ì¥ ì™„ë£Œ.`, 'success');
                loadAndRenderEvents(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                addLog(error.message, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë²¤íŠ¸ ëª©ë¡ ìë™ ë¡œë“œ
        window.onload = loadAndRenderEvents;
    </script>
</body>
</html>