<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ë‚ ì§œ ì •ê·œí™” ë“±ë¡</title>
    <style>
        :root { --primary: #0070f3; --bg: #f4f7f6; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 250px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; font-size: 14px; margin-bottom: 15px; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        #log { margin-top: 20px; padding: 15px; border-radius: 8px; background: #eee; font-size: 13px; max-height: 250px; overflow-y: auto; line-height: 1.6; }
        .success { color: #2ecc71; } .error { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ† ëŒ€íšŒ ì¼ì • ì •ê·œí™” ë“±ë¡</h1>
        <p>ì¹´í˜ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ <b>YYYY-MM-DD</b> í˜•ì‹ìœ¼ë¡œ ìë™ ë³€í™˜í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.</p>
        <select id="locationSelector" style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px;">
            <option value="local">êµ­ë‚´ (local)</option>
            <option value="abroad">í•´ì™¸ (abroad)</option>
        </select>
        <textarea id="rawText" placeholder="2026. 3. 29&#10;ì¼&#10;ë‚˜ì£¼ ëŒ€íšŒ..."></textarea>
        <button onclick="processData()">íŒŒì‹± ë° ì •ê·œí™” ì €ì¥ ì‹œì‘</button>
        <div id="log">ì¤€ë¹„ ì™„ë£Œ...</div>
    </div>

    <script>
        // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì •ê·œí™”í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
        function normalizeDate(dateStr) {
            // ëª¨ë“  ë§ˆì¹¨í‘œ, ê³µë°±ì„ í•˜ì´í”ˆìœ¼ë¡œ í†µì¼
            let clean = dateStr.replace(/\./g, '-').replace(/\s/g, '');
            let parts = clean.split('-');
            
            if (parts.length === 3) {
                let y = parts[0];
                let m = parts[1].padStart(2, '0'); // '3' -> '03'
                let d = parts[2].padStart(2, '0'); // '5' -> '05'
                return `${y}-${m}-${d}`;
            }
            return dateStr; // í˜•ì‹ì´ ì•ˆ ë§ìœ¼ë©´ ì›ë³¸ ë°˜í™˜
        }

        function addLog(msg, type = '') {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div class="${type}">${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function processData() {
            const text = document.getElementById('rawText').value;
            if(!text.trim()) return alert("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            const whereValue = document.getElementById('locationSelector').value;
            
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = "<b>ë¶„ì„ ë° ì •ê·œí™” ì‹œì‘...</b><br>";
            
            const lines = text.split('\n').map(l => l.trim()).filter(l => l !== "");
            let count = 0;

            for (let i = 0; i < lines.length; i++) {
                // ë‚ ì§œ íŒ¨í„´ ë§¤ì¹­ (2026. 3. 29 ë“±)
                const dateMatch = lines[i].match(/^(\d{4}\.\s?\d{1,2}\.\s?\d{1,2})/);
                
                if (dateMatch) {
                    const originalDate = dateMatch[1];
                    const standardizedDate = normalizeDate(originalDate); // ì •ê·œí™” ì‹¤í–‰
                    const title = lines[i+2]; // ìš”ì¼ ë‹¤ìŒ ì¤„ì´ ëŒ€íšŒëª…

                    if (title && !title.includes('ìš”ì¼')) {
                        try {
                            const res = await fetch('/api/ddays', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    id: title, // í•´ì‹œ í‚¤ë¡œ ì œëª© ì‚¬ìš©
                                    title: title,
                                    startDate: standardizedDate,
                                    type: 'public',
                                    where: whereValue
                                })
                            });
                            if (res.ok) {
                                addLog(`âœ… [${standardizedDate}] ${title}`, 'success');
                                count++;
                            }
                        } catch (err) {
                            addLog(`âŒ ì‹¤íŒ¨: ${title}`, 'error');
                        }
                    }
                }
            }
            addLog(`<br><b>ì´ ${count}ê°œì˜ ëŒ€íšŒê°€ ì •ê·œí™”ë˜ì–´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</b>`);
        }
    </script>
</body>
</html>