<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IM GURYE - Ultimate Professional Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="back_exit_handler.js" defer></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .chart-container { position: relative; height: 320px; width: 100%; }
        .card { background: white; border-radius: 2.5rem; border: 1px solid #e2e8f0; padding: 2rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        .athlete-chip { display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 99px; font-size: 13px; font-weight: 800; margin: 4px; color: white; cursor: pointer; transition: transform 0.2s; }
        .athlete-chip:hover { transform: translateY(-2px); }
        .guide-box { background: #f1f5f9; border-radius: 1.25rem; padding: 1.25rem; margin-bottom: 1.5rem; border-left: 5px solid #cbd5e1; }
        
        /* 테이블 스타일 */
        th.sortable { cursor: pointer; position: relative; transition: all 0.2s; white-space: nowrap; }
        th.sortable:hover { background-color: #f1f5f9; }
        th.sort-asc::after { content: ' ▲'; color: #ef4444; font-size: 11px; vertical-align: middle; }
        th.sort-desc::after { content: ' ▼'; color: #ef4444; font-size: 11px; vertical-align: middle; }
        th.active-sort { background-color: #fef2f2 !important; color: #ef4444; }
        
        /* 페이지네이션 */
        .page-num { cursor: pointer; padding: 0.6rem 1.1rem; border-radius: 0.85rem; font-weight: 800; font-size: 13px; border: 1px solid #e2e8f0; background: white; transition: all 0.2s; }
        .page-num:hover { background-color: #f1f5f9; border-color: #cbd5e1; }
        .page-num.active { background-color: #ef4444; color: white; border-color: #ef4444; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4); }
    </style>
</head>
<body class="leading-tight">

    <div id="setupSection" class="min-h-screen flex items-center justify-center p-6 bg-slate-50">
        <div class="card max-w-xl w-full text-center py-20 border-none shadow-2xl">
            <div class="mb-8">
                <i class="fas fa-trident text-red-600 text-6xl mb-4"></i>
                <h1 class="text-6xl font-black italic tracking-tighter uppercase">킹코스기록줄께 <BR><span class="text-red-600">차트다오</span></h1>
                <p class="text-slate-400 font-bold mt-2 uppercase tracking-widest">구례기록 CSV 파일분석 차트생성기</p>
            </div>
            <label class="block w-full cursor-pointer bg-white border-4 border-dashed border-slate-200 rounded-[3rem] p-16 hover:border-red-500 hover:bg-red-50/30 transition-all group">
                <input type="file" id="csvFileInput" accept=".csv" class="hidden" />
                <i class="fas fa-cloud-upload-alt text-6xl text-slate-300 group-hover:text-red-500 mb-6 transition-colors"></i>
                <span class="block font-black text-slate-700 text-xl mb-2">킹코스기록 CSV 파일 업로드</span>
                <span class="block text-slate-400 text-sm font-medium mb-4">기록 데이터를 불러와 분석을 시작하세요.</span>
                <div class="text-left text-[11px] text-slate-400 leading-relaxed bg-slate-50 p-4 rounded-xl border border-slate-100">
                    https://www.coachcox.co.uk/imstats/race/2460/results/에서 제공하는 CSV파일을 다운받아서 보면 한글이 깨지면서 셀이 제자리를 못찾는 행이 생겨보입니다. 분석프로그램에서는 수정없이 그대로 업로드하면 저절로 파싱해서 문제없이 분석합니다. 다만, 분석대상은 Rank가 기록되어 있는 Finisher 만 대상으로 합니다. 특히, 구례대회 등록할때 꼭 에이지 그룹으로 신청하세요. 오픈디비젼(ODIV)으로 신청하면 저 CSV에 기록이 포함되지 않습니다.
                </div>
            </label>
        </div>
    </div>

    <div id="mainDashboard" class="hidden min-h-screen pb-24">
        <header class="bg-white/95 backdrop-blur-xl sticky top-0 z-50 border-b border-slate-200 px-6 py-4">
            <div class="max-w-[1600px] mx-auto flex flex-col lg:flex-row items-center gap-6">
                <div class="font-black text-3xl italic flex-shrink-0 tracking-tighter">나는 차트<span class="text-red-600">구례</span></div>
                <div class="flex-1 flex gap-3 w-full">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="searchBox" placeholder="선수 이름 또는 배번을 입력하여 검색하세요" class="w-full bg-slate-100 rounded-2xl pl-12 pr-5 py-4 outline-none focus:ring-4 focus:ring-red-500/10 focus:bg-white font-bold transition-all">
                    </div>
                    <button id="addMeBtn" class="bg-slate-900 text-white px-8 py-4 rounded-2xl font-black text-sm whitespace-nowrap hover:bg-black transition-all">분석기준선수로 등록</button>
                    <button id="addCompareBtn" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black text-sm whitespace-nowrap hover:bg-blue-700 transition-all">비교군 추가</button>
                </div>
                <button id="downloadHtmlBtn" class="bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black text-sm whitespace-nowrap hover:bg-emerald-700 shadow-lg shadow-emerald-100 transition-all">
                    <i class="fas fa-file-download mr-2"></i>리포트 다운로드
                </button>
            </div>
        </header>

        <main class="max-w-[1600px] mx-auto p-4 md:p-8 space-y-10">
            <div class="bg-white rounded-3xl p-6 shadow-lg border border-slate-200 relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-2xl font-black italic mb-2 tracking-tight uppercase text-slate-800 flex items-center gap-2">
                        <i class="fas fa-info-circle text-red-500"></i> 철인 기록 분석 가이드
                    </h2>
                    <p class="text-slate-600 text-sm leading-relaxed font-medium max-w-5xl">
                        현재 대시보드는 <span class="text-red-600 font-bold underline decoration-2">전체 참가자의 평균 기록</span> 선수를 기준으로 설정되었습니다.
                        기준 선수 대비 ±20/40/60분 차이 선수들이 비교군으로 자동 설정됩니다. 본인 기록으로 분석하려면 검색창에 배번 입력 후 <span class="text-slate-800 font-bold bg-slate-100 px-2 py-0.5 rounded border border-slate-300">분석기준선수로 등록</span> 버튼을 눌러주세요.
                    </p>
                </div>
                <i class="fas fa-bolt absolute -right-6 -bottom-6 text-9xl text-slate-50 -rotate-12 pointer-events-none"></i>
            </div>

            <div id="athleteList" class="flex flex-wrap min-h-[50px] gap-2 px-2"></div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="card lg:col-span-2">
                    <div class="guide-box border-l-slate-800">
                        <h5 class="font-black text-slate-800 text-base mb-2 uppercase flex flex-wrap items-center justify-between gap-2">
                            <span class="flex items-center"><i class="fas fa-chart-area mr-2"></i>기록 분포 분석</span>
                            <div class="flex items-center gap-3 text-[11px] bg-white px-3 py-1 rounded-lg border border-slate-200 shadow-sm">
                                <label class="flex items-center cursor-pointer hover:text-red-600"><input type="radio" name="distMetric" value="t" checked onchange="updateDashboard()" class="mr-1 accent-red-500">Total</label>
                                <label class="flex items-center cursor-pointer hover:text-blue-600"><input type="radio" name="distMetric" value="s" onchange="updateDashboard()" class="mr-1 accent-blue-500">Swim</label>
                                <label class="flex items-center cursor-pointer hover:text-green-600"><input type="radio" name="distMetric" value="bk" onchange="updateDashboard()" class="mr-1 accent-green-500">Bike</label>
                                <label class="flex items-center cursor-pointer hover:text-orange-600"><input type="radio" name="distMetric" value="rn" onchange="updateDashboard()" class="mr-1 accent-orange-500">Run</label>
                            </div>
                        </h5>
                        <p class="text-sm text-slate-500 leading-relaxed font-semibold italic">전체 참가자의 완주 시간 분포 그래프입니다. 회색 바가 높을수록 해당 시간대에 많은 선수가 몰려 있음을 의미합니다. <span class="text-red-600">빨간 점(Me)</span>이 분석기준선수이고, <span class="text-red-600 border-b-2 border-dashed border-red-600">붉은 점선</span>은 선택된 그룹의 평균 기록입니다. <span class="text-blue-600 cursor-pointer font-bold">막대를 클릭하면 해당 시간대 선수들이 아래 테이블에 필터링됩니다.</span></p>
                        <div class="mt-3">
                            <select id="distFilter" class="bg-white border border-slate-200 text-slate-700 text-xs font-bold rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2" onchange="filteredData=null; updateDashboard()">
                                <option value="All">All Divisions</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="distChart"></canvas></div>
                </div>

                <div class="card">
                    <div class="guide-box border-l-red-500">
                        <h5 class="font-black text-red-600 text-base mb-2 uppercase flex items-center"><i class="fas fa-tachometer-alt mr-2"></i>종목별 밸런스 점수 (Ability Balance)</h5>
                        <p class="text-sm text-slate-500 leading-relaxed font-semibold italic">전체 평균을 50점으로 환산했을 때 나의 종목별 상대 점수입니다. 100점에 가까울수록 해당 종목에서 압도적인 기량을 가졌음을 뜻합니다. 레이더 차트의 면적이 정삼각형에 가깝게 넓어지는 것이 이상적인 훈련 목표입니다.</p>
                    </div>
                    <div class="chart-container" style="height: 640px"><canvas id="radarChart"></canvas></div>
                </div>

                <div class="card">
                    <div class="guide-box border-l-blue-600">
                        <h5 class="font-black text-blue-600 text-base mb-2 uppercase flex items-center"><i class="fas fa-project-diagram mr-2"></i>구간별 순위 변동 추이 (Rank Flow)</h5>
                        <p class="text-sm text-slate-500 leading-relaxed font-semibold italic">수영, 사이클, 런 각 구간을 마쳤을 때의 실시간 순위 변화를 추적합니다. <span class="text-slate-400 font-bold">회색선</span>은 <span id="flowDesc" class="text-slate-800 font-bold decoration-2 underline decoration-slate-300 underline-offset-2">분석기준선수(Me)보다 기록이 빠른 10명과 느린 10명의 흐름</span>입니다. 그래프가 우상향한다면 뒷심이 강한 것이고, 우하향한다면 해당 종목 이후 체력이 급격히 저하됨을 의미합니다. <span class="text-blue-600 cursor-pointer">선을 클릭하면 상세 정보가 표시됩니다.</span></p>
                    </div>
                    <div class="chart-container relative" style="height: 640px">
                        <canvas id="flowChart"></canvas>
                        <div id="flowTooltip" class="hidden absolute top-2 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur border border-slate-200 shadow-xl rounded-xl p-3 text-xs z-10 transition-all min-w-[200px]"></div>
                    </div>
                </div>
            </div>

            <div class="card overflow-hidden" id="recordTableSection">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 px-2 gap-4">
                    <div>
                        <h3 class="font-black italic text-2xl uppercase tracking-tighter">Full Race Database</h3>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">Click headers to sort / Page size: 50</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="resetFilterBtn" class="hidden bg-slate-200 text-slate-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-slate-300 transition-colors" onclick="resetTableFilter()">
                            <i class="fas fa-undo mr-1"></i>필터 해제 전체보기
                        </button>
                        <div id="tableStats" class="bg-red-50 text-red-600 px-5 py-2 rounded-xl text-xs font-black tracking-widest border border-red-100"></div>
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-2 mb-4 px-6">
                    <button onclick="applyBenchmarkFilter('s')" class="bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all shadow-sm"><i class="fas fa-swimmer mr-1"></i>수영 빠른 20명</button>
                    <button onclick="applyBenchmarkFilter('bk')" class="bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all shadow-sm"><i class="fas fa-biking mr-1"></i>사이클 빠른 20명</button>
                    <button onclick="applyBenchmarkFilter('rn')" class="bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all shadow-sm"><i class="fas fa-running mr-1"></i>런 빠른 20명</button>
                    <span class="text-xs text-slate-400 font-medium ml-2">누르면 목록 필터링과 동시에 구간별 순위 변동 추이에 회색선으로 반영됩니다.</span>
                </div>
                <div class="px-6 mb-3 text-xs font-bold flex flex-col sm:flex-row gap-2">
                    <span class="text-red-600 flex items-center"><i class="fas fa-mouse-pointer mr-2"></i> [이름을 누르면 분석기준선수로 등록됩니다]</span>
                    <span class="text-blue-600 flex items-center"><i class="fas fa-mouse-pointer mr-2"></i> [배번을 누르면 비교군으로 추가됩니다]</span>
                </div>
                
                <div class="overflow-x-auto border-y border-slate-100">
                    <table class="w-full text-left text-sm border-collapse">
                        <thead>
                            <tr class="bg-slate-50/80">
                                <th class="sortable py-2 px-3 font-black uppercase text-[11px] active-sort sort-asc" data-col="ro">Rank</th>
                                <th class="sortable py-2 px-3 font-black uppercase text-[11px]" data-col="b">Bib No.</th>
                                <th class="sortable py-2 px-3 font-black uppercase text-[11px]" data-col="n">Athlete Name</th>
                                <th class="sortable py-2 px-3 font-black uppercase text-[11px]" data-col="d">Division</th>
                                <th class="sortable py-2 px-3 font-black uppercase text-[11px]" data-col="s">Swim</th>
                                <th class="sortable py-2 px-3 font-black uppercase text-[11px]" data-col="t1">T1</th>
                                <th class="sortable py-2 px-3 font-black uppercase text-[11px]" data-col="bk">Bike</th>
                                <th class="sortable py-2 px-3 font-black uppercase text-[11px]" data-col="t2">T2</th>
                                <th class="sortable py-2 px-3 font-black uppercase text-[11px]" data-col="rn">Run</th>
                                <th class="sortable py-2 px-3 font-black uppercase text-[11px]" data-col="t">Total Time</th>
                            </tr>
                        </thead>
                        <tbody id="recordBody" class="font-bold text-slate-700"></tbody>
                    </table>
                </div>

                <div class="flex flex-col items-center mt-10 space-y-4">
                    <div class="flex items-center gap-2" id="paginationNumbers"></div>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Go to page to view more athletes</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let raceData = null; let filteredData = null; let filterReason = ""; let me = null; let competitors = []; let charts = {};
        let currentSort = { col: 'ro', dir: 'asc' };
        let currentPage = 1; const pageSize = 50;
        const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#ec4899'];

        const hmsToS = (s) => { 
            if(!s || !s.includes(':')) return 0; 
            const p = s.split(':').map(Number); 
            if(p.length===3) return p[0]*3600+p[1]*60+p[2];
            if(p.length===2) return p[0]*60+p[1];
            return 0; 
        };
        const sToHms = (s) => { if(s<=0) return "--:--:--"; const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; };

        // 로컬 파일 로드 체크
        window.onload = () => {
            if (window.embeddedData) {
                raceData = window.embeddedData; me = window.embeddedMe;
                if (window.embeddedCompetitors) competitors = window.embeddedCompetitors;
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                initDistFilterOptions();
                updateAthleteList(); updateDashboard();
            }
        };

        // CSV 파일 파싱
        document.getElementById('csvFileInput').onchange = (e) => {
            Papa.parse(e.target.files[0], {
                header: true, skipEmptyLines: true, encoding: "UTF-8",
                complete: (r) => {
                    raceData = r.data.map(x => ({
                        b: x['Bib'], n: x['Name'], d: x['Division'],
                        t: hmsToS(x['Overall Time']), s: hmsToS(x['Swim Time']), t1: hmsToS(x['Transition 1 Time'] || x['T1 Time'] || x['T1']),
                        bk: hmsToS(x['Bike Time']), t2: hmsToS(x['Transition 2 Time'] || x['T2 Time'] || x['T2']), rn: hmsToS(x['Run Time']),
                        ro: parseInt(x['Overall Rank']), ra: parseInt(x['Age Group Rank'])
                    })).filter(v => v.t > 0);
                    initDistFilterOptions();
                    initSub10Analysis();
                    document.getElementById('setupSection').classList.add('hidden');
                    document.getElementById('mainDashboard').classList.remove('hidden');
                }
            });
        };

        function initDistFilterOptions() {
            const sel = document.getElementById('distFilter');
            if(!sel || !raceData) return;
            sel.innerHTML = '<option value="All">All Divisions</option>';
            const divisions = [...new Set(raceData.map(x => x.d))].sort();
            divisions.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.innerText = d;
                sel.appendChild(opt);
            });
        }

        // 초기 Sub-10 분석 로직
        function initSub10Analysis() {
            if (!raceData || raceData.length === 0) return;

            // 1. 전체 평균 계산 및 Me 설정
            const avgT = raceData.reduce((a, b) => a + b.t, 0) / raceData.length;
            me = raceData.reduce((prev, curr) => Math.abs(curr.t - avgT) < Math.abs(prev.t - avgT) ? curr : prev);

            // 2. 비교군 설정 (-60m, -40m, -20m, +20m, +40m, +60m)
            competitors = [];
            const timeDiffs = [-3600, -2400, -1200, 1200, 2400, 3600]; // 초 단위
            
            timeDiffs.forEach(diff => {
                const targetTime = me.t + diff;
                let bestMatch = null;
                let minDiff = Infinity;
                for (const p of raceData) {
                    if (p.b === me.b || competitors.some(c => c.b === p.b)) continue;
                    const d = Math.abs(p.t - targetTime);
                    if (d < minDiff) { minDiff = d; bestMatch = p; }
                }
                if (bestMatch) competitors.push(bestMatch);
            });
            
            updateAthleteList(); updateDashboard();
        }

        // 테이블 렌더링 및 페이지네이션
        function renderTable() {
            const sourceData = filteredData || raceData;
            const sortedData = [...sourceData].sort((a, b) => {
                let valA = a[currentSort.col], valB = b[currentSort.col];
                if (typeof valA === 'string') return currentSort.dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                return currentSort.dir === 'asc' ? valA - valB : valB - valA;
            });

            const totalPages = Math.ceil(sourceData.length / pageSize);
            const start = (currentPage - 1) * pageSize;
            const paginated = sortedData.slice(start, start + pageSize);
            
            document.getElementById('recordBody').innerHTML = paginated.map(row => `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition-all ${me && row.b === me.b ? 'bg-red-50/60' : ''}">
                    <td class="py-2 px-3 font-black ${currentSort.col === 'ro' ? 'text-red-600' : ''}">${row.ro}</td>
                    <td class="py-2 px-3 text-slate-400 font-mono text-xs cursor-pointer hover:text-blue-600 hover:font-bold transition-colors" onclick="addCompetitorByBib('${row.b}')" title="비교군에 추가">${row.b}</td>
                    <td class="py-2 px-3 font-black text-slate-900 text-base cursor-pointer hover:text-red-600 transition-colors" onclick="setAsMeByBib('${row.b}')" title="분석기준선수로 등록">${row.n}</td>
                    <td class="py-2 px-3 text-xs font-bold text-slate-500 uppercase tracking-tighter">${row.d}</td>
                    <td class="py-2 px-3 text-slate-500 font-medium">${sToHms(row.s)}</td>
                    <td class="py-2 px-3 text-slate-400 font-medium text-xs">${sToHms(row.t1)}</td>
                    <td class="py-2 px-3 text-slate-500 font-medium">${sToHms(row.bk)}</td>
                    <td class="py-2 px-3 text-slate-400 font-medium text-xs">${sToHms(row.t2)}</td>
                    <td class="py-2 px-3 text-slate-500 font-medium">${sToHms(row.rn)}</td>
                    <td class="py-2 px-3 font-black text-slate-900">${sToHms(row.t)}</td>
                </tr>`).join('');

            const resetBtn = document.getElementById('resetFilterBtn');
            if (filteredData) resetBtn.classList.remove('hidden');
            else resetBtn.classList.add('hidden');

            const reasonText = filterReason ? ` (${filterReason})` : (filteredData ? ' (FILTERED)' : '');
            document.getElementById('tableStats').innerText = `SHOWING ${start+1} - ${Math.min(start+pageSize, sourceData.length)} OF ${sourceData.length.toLocaleString()} ATHLETES${reasonText}`;

            renderPagination(totalPages);
        }

        function resetTableFilter() {
            filteredData = null;
            filterReason = "";
            currentPage = 1;
            renderTable();
            updateDashboard(); // 차트도 초기화
        }

                function applyBenchmarkFilter(type) {
            if (!me) return alert("먼저 분석기준선수를 등록해주세요.");
            
            // 해당 종목 기록순 정렬
            const sorted = [...raceData].sort((a, b) => a[type] - b[type]);
            const meIdx = sorted.findIndex(x => x.b === me.b);
            
            if (meIdx === -1) return;
            
            // 나보다 빠른 20명 추출 (나 포함)
            const start = Math.max(0, meIdx - 20);
            const subset = sorted.slice(start, meIdx + 1);
            
            filteredData = subset;
            const typeName = type === 's' ? '수영' : (type === 'bk' ? '사이클' : '런');
            filterReason = `${me.n}보다 ${typeName} 빠른 20명`;
            
            currentPage = 1;
            updateDashboard(); // 차트 및 테이블 업데이트
            document.getElementById('flowChart').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function renderPagination(total) {
            const container = document.getElementById('paginationNumbers');
            container.innerHTML = '';
            
            const blockSize = 10;
            const currentBlock = Math.ceil(currentPage / blockSize);
            const startPage = (currentBlock - 1) * blockSize + 1;
            const endPage = Math.min(currentBlock * blockSize, total);

            // First Page (<<)
            container.innerHTML += `<span class="page-num ${currentPage > 1 ? '' : 'opacity-30 pointer-events-none'}" onclick="goToPage(1)" title="First Page"><i class="fas fa-angle-double-left"></i></span>`;

            // Prev 10 Pages (<)
            const prevBlockPage = startPage - 1;
            container.innerHTML += `<span class="page-num ${prevBlockPage > 0 ? '' : 'opacity-30 pointer-events-none'}" onclick="${prevBlockPage > 0 ? `goToPage(${prevBlockPage})` : ''}" title="Previous 10 Pages"><i class="fas fa-angle-left"></i></span>`;

            // Page Numbers
            for (let i = startPage; i <= endPage; i++) {
                container.innerHTML += `<span class="page-num ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</span>`;
            }

            // Next 10 Pages (>)
            const nextBlockPage = endPage + 1;
            container.innerHTML += `<span class="page-num ${nextBlockPage <= total ? '' : 'opacity-30 pointer-events-none'}" onclick="${nextBlockPage <= total ? `goToPage(${nextBlockPage})` : ''}" title="Next 10 Pages"><i class="fas fa-angle-right"></i></span>`;

            // Last Page (>>)
            container.innerHTML += `<span class="page-num ${currentPage < total ? '' : 'opacity-30 pointer-events-none'}" onclick="goToPage(${total})" title="Last Page"><i class="fas fa-angle-double-right"></i></span>`;
        }

        function goToPage(p) { 
            currentPage = p; renderTable(); 
            document.getElementById('recordTableSection').scrollIntoView({ behavior: 'smooth', block: 'start' }); 
        }

        // 정렬 기능 (1페이지 리셋 포함)
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.col;
                if (currentSort.col === col) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                else { currentSort.col = col; currentSort.dir = 'asc'; }
                
                currentPage = 1; // 정렬 시 무조건 1페이지로
                
                document.querySelectorAll('th.sortable').forEach(h => h.className = 'sortable py-2 px-3 font-black uppercase text-[11px]');
                th.classList.add('active-sort', currentSort.dir === 'asc' ? 'sort-asc' : 'sort-desc');
                renderTable();
            });
        });

        // 다운로드 기능
        document.getElementById('downloadHtmlBtn').onclick = () => {
            if (!raceData) return;
            const dataScript = `<script>window.embeddedData=${JSON.stringify(raceData)};window.embeddedMe=${JSON.stringify(me)};window.embeddedCompetitors=${JSON.stringify(competitors)};<\/script>`;
            const finalHtml = document.documentElement.outerHTML.replace('<\/body>', dataScript + '<\/body>');
            const blob = new Blob([finalHtml], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `IM_Report_${me ? me.n : 'Full'}.html`;
            link.click();
        };

        // 대시보드 업데이트 (차트 렌더링)
        function updateDashboard() {
            const activeAthletes = [];
            if (me) activeAthletes.push({ data: me, color: '#ef4444', label: `${me.n} (Me)` });
            competitors.forEach((c, i) => activeAthletes.push({ data: c, color: colors[(i + 1) % colors.length], label: c.n }));
            
            renderRadar(activeAthletes); renderFlow(activeAthletes); renderDist(activeAthletes);
            renderTable();
        }

        function renderRadar(athletes) {
            const getScore = (val, k) => {
                const arr = raceData.map(x => x[k]).filter(v => v > 0).sort((a,b)=>a-b);
                return 100 - (arr.findIndex(v => v >= val) / arr.length * 100);
            };
            const datasets = athletes.map(a => ({
                label: a.label, data: [getScore(a.data.s,'s'), getScore(a.data.bk,'bk'), getScore(a.data.rn,'rn')],
                borderColor: a.color, backgroundColor: a.color + '1A', fill: true, borderWidth: 4, pointRadius: 4
            }));
            if(charts.radar) charts.radar.destroy();
            charts.radar = new Chart(document.getElementById('radarChart'), { 
                type:'radar', data:{ labels:['수영 점수','사이클 점수','런 점수'], datasets }, 
                options:{ maintainAspectRatio:false, scales:{r:{min:0, max:100, ticks:{display:true, stepSize:20, backdropColor:'transparent'}, grid:{color:'#e2e8f0'}, angleLines:{color:'#e2e8f0'}}}, plugins:{legend:{position:'bottom', labels:{font:{weight:'bold', size:11}}}} } 
            });
        }

        function renderFlow(athletes) {
            if (!me || !raceData) return;

            // Lazy init ranks if not present
            if (raceData.length > 0 && typeof raceData[0].sRank === 'undefined') {
                const addRank = (key, valFunc) => {
                    [...raceData].sort((a,b) => valFunc(a) - valFunc(b)).forEach((x, i) => x[key] = i + 1);
                };
                addRank('sRank', x => x.s);
                addRank('bRank', x => x.s + x.t1 + x.bk);
            }

            const sorted = [...raceData].sort((a,b) => a.ro - b.ro);
            const meIdx = sorted.findIndex(x => x.b === me.b);
            if (meIdx < 0) return;

            let subset;
            if (filteredData && filteredData.length > 0) {
                subset = filteredData;
            } else {
                const start = Math.max(0, meIdx - 10);
                const end = Math.min(sorted.length, meIdx + 11);
                subset = sorted.slice(start, end);
            }

            const descEl = document.getElementById('flowDesc');
            if (descEl) {
                descEl.innerText = (filteredData && filterReason) ? filterReason + "의 흐름" : "분석기준선수(Me)보다 기록이 빠른 10명과 느린 10명의 흐름";
            }

            // Merge context subset and highlighted athletes
            const combinedMap = new Map();
            
            // 1. Add context athletes (Gray)
            subset.forEach(a => {
                combinedMap.set(a.b, { 
                    data: a, color: '#cbd5e1', width: 2, hoverColor: '#64748b', order: 1 
                });
            });

            // 2. Add highlighted athletes (Colored)
            athletes.forEach(item => {
                combinedMap.set(item.data.b, { 
                    data: item.data, color: item.color, width: 4, hoverColor: item.color, order: 0 
                });
            });

            const finalAthletes = Array.from(combinedMap.values());

            let minR = Infinity, maxR = -Infinity;
            const datasets = finalAthletes.map(item => {
                const a = item.data;
                const r1 = a.sRank, r2 = a.bRank, r3 = a.ro;
                minR = Math.min(minR, r1, r2, r3);
                maxR = Math.max(maxR, r1, r2, r3);
                return {
                    label: a.n, data: [r1, r2, r3],
                    borderColor: item.color, borderWidth: item.width,
                    hoverBorderColor: item.hoverColor, hoverBorderWidth: 4,
                    tension: 0.4, pointRadius: item.order === 0 ? 3 : 0, pointHoverRadius: 5, pointHitRadius: 25, order: item.order,
                    rawAthlete: a
                };
            });

            if(charts.flow) charts.flow.destroy();
            charts.flow = new Chart(document.getElementById('flowChart'), { 
                type:'line', data:{ labels:['수영 피니시','사이클 피니시','런 피니시'], datasets }, 
                options:{ 
                    maintainAspectRatio:false, 
                    interaction: { mode: 'nearest', axis: 'xy', intersect: false },
                    scales:{ y:{ reverse:true, min: minR, max: maxR, grid:{color:'#f1f5f9'}, ticks:{stepSize:1}, title: { display: true, text: 'Rank' } } }, 
                    plugins:{ legend:{display:false}, tooltip:{enabled: false} },
                    onHover: (e, elements, chart) => {
                        const tooltipEl = document.getElementById('flowTooltip');
                        if (!elements || elements.length === 0) {
                            tooltipEl.classList.add('hidden');
                            return;
                        }
                        const datasetIndex = elements[0].datasetIndex;
                        const dataset = chart.data.datasets[datasetIndex];
                        const a = dataset.rawAthlete;
                        
                        tooltipEl.innerHTML = `
                            <div class="flex items-center justify-between mb-2 border-b border-slate-100 pb-1">
                                <span class="font-black text-sm" style="color:${dataset.borderColor}">${a.n}</span>
                                <span class="text-[10px] font-mono text-slate-400">#${a.b}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-slate-600 font-medium">
                                <span>Total: <b class="text-slate-800">${sToHms(a.t)}</b></span>
                                <span>Rank: <b class="text-slate-800">${a.ro}</b></span>
                                <span>Swim: ${sToHms(a.s)}</span>
                                <span>Bike: ${sToHms(a.bk)}</span>
                                <span>Run: ${sToHms(a.rn)}</span>
                            </div>
                        `;
                        tooltipEl.classList.remove('hidden');
                    }
                }
            });
        }

        function renderDist(athletes) {
            const filterVal = document.getElementById('distFilter') ? document.getElementById('distFilter').value : 'All';
            const metricEl = document.querySelector('input[name="distMetric"]:checked');
            const metric = metricEl ? metricEl.value : 't';
            
            // Global bounds calculation (always based on full raceData)
            const bins = 40; 
            const globalValues = raceData.map(x=>x[metric]).filter(v => v > 0).sort((a,b)=>a-b);
            if(globalValues.length === 0) return;
            const min = globalValues[0], max = globalValues[globalValues.length-1];
            const step = (max === min) ? 60 : (max-min)/bins;

            // Calculate Global Counts for background
            const globalCounts = Array(bins).fill(0);
            raceData.forEach(x => {
                const val = x[metric];
                if(val > 0 && val >= min && val <= max) globalCounts[Math.min(Math.floor((val-min)/step), bins-1)]++;
            });

            let data = raceData;
            if (filterVal && filterVal !== 'All') {
                data = raceData.filter(x => x.d === filterVal);
            }
            
            const counts = Array(bins).fill(0); 
            data.forEach(x => {
                const val = x[metric];
                if(val > 0 && val >= min && val <= max) counts[Math.min(Math.floor((val-min)/step), bins-1)]++;
            });

            const validData = data.filter(x => x[metric] > 0);
            const avgTime = validData.length > 0 ? validData.reduce((a,b) => a + b[metric], 0) / validData.length : 0;
            const avgIndex = (avgTime - min) / step;
            
            const labels = Array(bins).fill(0).map((_, i) => sToHms(min + i * step).substring(0, 5));

            const datasets = [];
            // 1. Athletes Markers (Top layer)
            datasets.push(...athletes.map(a => {
                const val = a.data[metric];
                if (val < min || val > max || val <= 0) return null;
                const athleteIdx = Math.min(Math.floor((val-min)/step), bins-1);
                return {
                    label: a.label, type: 'line', data: counts.map((c, i) => i === athleteIdx ? c : null),
                    borderColor: a.color, backgroundColor: a.color, pointRadius: 6, pointHoverRadius: 12, showLine: false,
                    datalabels: { display: false }, order: 1
                };
            }).filter(x => x));

            // 2. Selected Group Distribution (Middle layer)
            datasets.push({ 
                label: filterVal === 'All' ? 'Overall' : filterVal, type: 'bar', data: counts, 
                backgroundColor: filterVal === 'All' ? '#e2e8f0' : '#94a3b8', 
                barPercentage: 0.9, categoryPercentage: 0.9, grouped: false, order: 2,
                datalabels: { anchor: 'end', align: 'end', color: '#64748b', font: {size:10, weight:'bold'}, formatter: (v)=>v>0?v:'' }
            });

            // 3. Overall Context Background (Bottom layer)
            if (filterVal !== 'All') {
                datasets.push({
                    label: 'Overall Context', type: 'bar', data: globalCounts,
                    backgroundColor: '#f1f5f9', barPercentage: 0.9, categoryPercentage: 0.9, grouped: false, order: 3,
                    datalabels: { display: false }
                });
            }

            const avgLinePlugin = {
                id: 'avgLine',
                afterDatasetsDraw(chart) {
                    const { ctx, scales: { x, y } } = chart;
                    if (!avgTime || avgIndex < 0 || avgIndex >= bins) return;
                    
                    const x0 = x.getPixelForValue(0);
                    const x1 = x.getPixelForValue(1);
                    const width = x1 - x0;
                    const xPos = x0 + (avgIndex - 0.5) * width;
                    
                    ctx.save();
                    ctx.beginPath();
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.moveTo(xPos, y.top);
                    ctx.lineTo(xPos, y.bottom);
                    ctx.stroke();
                    
                    ctx.fillStyle = '#ef4444';
                    ctx.font = 'bold 11px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(`AVG ${sToHms(avgTime).substring(0,5)}`, xPos, y.top - 8);
                    ctx.restore();
                }
            };

            if(charts.dist) charts.dist.destroy();
            charts.dist = new Chart(document.getElementById('distChart'), {
                plugins: [ChartDataLabels, avgLinePlugin],
                type:'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: { 
                    maintainAspectRatio: false, 
                    scales: { 
                        x: { display: true, ticks: { maxTicksLimit: 10, autoSkip: true, maxRotation: 0 } }, 
                        y: { display: false, grace: '5%' } 
                    }, 
                    plugins:{
                        legend:{
                            position:'bottom',
                            labels: { padding: 20 },
                        },
                        tooltip: { callbacks: { title: (ctx) => `Time: ${ctx[0].label} ~` } }
                    },
                    layout: { padding: { top: 0 } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const rangeStart = min + index * step;
                            const rangeEnd = min + (index + 1) * step;
                            
                            filteredData = data.filter(x => x[metric] >= rangeStart && x[metric] < rangeEnd);
                            const metricName = metric === 't' ? 'Total' : (metric === 's' ? 'Swim' : (metric === 'bk' ? 'Bike' : 'Run'));
                            filterReason = `${metricName}: ${sToHms(rangeStart).substring(0,5)}~`;
                            currentPage = 1;
                            renderTable();
                            document.getElementById('recordTableSection').scrollIntoView({ behavior: 'smooth' });
                        } else {
                            if (filteredData) {
                                filteredData = null;
                                filterReason = "";
                                currentPage = 1;
                                renderTable();
                            }
                        }
                    }
                }
            });
        }

        // 상단 칩셋 관리
        function updateAthleteList() {
            const list = document.getElementById('athleteList');
            list.innerHTML = '';
            if (me) {
                list.innerHTML += `<div class="athlete-chip shadow-xl shadow-red-200" style="background:#ef4444" onclick="removeAthlete('${me.b}')"><i class="fas fa-user-check mr-2"></i>분석기준: ${me.n} ✕</div>`;
            }
            competitors.forEach((c, i) => {
                const color = colors[(i + 1) % colors.length];
                list.innerHTML += `<div class="athlete-chip shadow-lg" style="background:${color}" onclick="removeAthlete('${c.b}')">${c.n} ✕</div>`;
            });
        }

        // 버튼 이벤트들
        function setAsMe(user) {
            if (!user) return;
            me = user;
            updateAthleteList();
            updateDashboard();
        }

        function setAsMeByBib(bib) {
            const user = raceData.find(x => x.b === bib);
            setAsMe(user);
        }

        document.getElementById('addMeBtn').onclick = () => {
            const val = document.getElementById('searchBox').value;
            const user = raceData.find(x => x.b === val || x.n === val);
            setAsMe(user);
        };

        document.getElementById('addCompareBtn').onclick = () => {
            const val = document.getElementById('searchBox').value;
            const user = raceData.find(x => x.b === val || x.n === val);
            addCompetitorByBib(user?.b);
        };

        function addCompetitorByBib(bib) {
            if (!bib) return;
            const user = raceData.find(x => x.b === bib);
            if (user) {
                if (me && me.b === user.b) return alert('이미 "분석기준선수"로 등록된 선수입니다.');
                if (competitors.find(c => c.b === user.b)) return alert('이미 비교군에 등록된 선수입니다.');
                
                competitors.push(user); 
                updateAthleteList(); updateDashboard();
            }
        }

        function removeAthlete(bib) {
            if (me && me.b === bib) me = null;
            else competitors = competitors.filter(c => c.b !== bib);
            updateAthleteList(); updateDashboard();
        }
    </script>
</body>
</html>