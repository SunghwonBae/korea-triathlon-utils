<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ironman CSV to JSON Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .card { background: white; border-radius: 1.5rem; padding: 2.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); border: 1px solid #f1f5f9; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

    <div class="card max-w-2xl w-full text-center">
        <div class="mb-10">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-red-50 mb-6 text-red-500">
                <i class="fas fa-file-csv text-3xl"></i>
            </div>
            <h1 class="text-4xl font-black text-slate-800 mb-2">CSV to JSON ë³€í™˜ê¸°</h1>
            <p class="text-slate-500 font-medium">CoachCox ìŠ¤íƒ€ì¼ì˜ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´<br>ë¶„ì„ìš© JSON íŒŒì¼ë¡œ ë³€í™˜í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
        </div>

        <label class="block w-full cursor-pointer bg-slate-50 border-4 border-dashed border-slate-200 rounded-3xl p-12 hover:border-red-500 hover:bg-red-50/30 transition-all group">
            <input type="file" id="csvFileInput" accept=".csv" class="hidden" />
            <i class="fas fa-file-import text-5xl text-slate-300 group-hover:text-red-500 mb-4 transition-colors"></i>
            <span class="block font-bold text-slate-700 text-lg mb-1">CSV íŒŒì¼ ì„ íƒ</span>
            <span class="block text-slate-400 text-sm">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</span>
        </label>

        <div id="statusArea" class="mt-8 hidden">
            <div class="flex items-center justify-center gap-2 text-red-600 font-bold animate-pulse">
                <i class="fas fa-spinner fa-spin"></i> ì²˜ë¦¬ ì¤‘...
            </div>
        </div>

        <div class="mt-10 text-left bg-slate-100 p-5 rounded-xl text-xs text-slate-500 leading-relaxed">
            <strong>ğŸ’¡ ì‚¬ìš© ë°©ë²•:</strong><br>
            1. ë³€í™˜ëœ JSON íŒŒì¼ì€ ì„œë²„ì˜ <code>/public/data/ironman/</code> ê²½ë¡œì— ì—…ë¡œë“œí•˜ì„¸ìš”.<br>
            2. íŒŒì¼ëª…ì€ ì˜ë¬¸ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤ (ì˜ˆ: <code>gurye_2024.json</code>).<br>
            3. ì—…ë¡œë“œ í›„ <code>report_ironman.html</code>ì—ì„œ í•´ë‹¹ ëŒ€íšŒë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    </div>

    <script>
        const hmsToS = (s) => { 
            if(!s || !s.includes(':')) return 0; 
            const p = s.split(':').map(Number); 
            if(p.length===3) return p[0]*3600+p[1]*60+p[2];
            if(p.length===2) return p[0]*60+p[1];
            return 0; 
        };

        document.getElementById('csvFileInput').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;

            document.getElementById('statusArea').classList.remove('hidden');
            
            Papa.parse(file, {
                header: true, skipEmptyLines: true, encoding: "UTF-8",
                complete: (r) => {
                    // ë°ì´í„° ì •ì œ ë° ë³€í™˜
                    const data = r.data.map(x => ({
                        b: x['Bib'], n: x['Name'], d: x['Division'], c: x['Country'], q: x['Qualified'],
                        t: hmsToS(x['Overall Time']), s: hmsToS(x['Swim Time']), t1: hmsToS(x['Transition 1 Time'] || x['T1 Time'] || x['T1']),
                        bk: hmsToS(x['Bike Time']), t2: hmsToS(x['Transition 2 Time'] || x['T2 Time'] || x['T2']), rn: hmsToS(x['Run Time']),
                        ro: parseInt(x['Overall Rank']), ra: parseInt(x['Age Group Rank'])
                    })).filter(v => v.t > 0);

                    // JSON ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
                    const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name.replace('.csv', '.json');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    document.getElementById('statusArea').classList.add('hidden');
                    alert(`ë³€í™˜ ì™„ë£Œ! ${data.length}ëª…ì˜ ë°ì´í„°ê°€ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                },
                error: (err) => {
                    alert("CSV íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
                    document.getElementById('statusArea').classList.add('hidden');
                }
            });
        };
    </script>
</body>
</html>