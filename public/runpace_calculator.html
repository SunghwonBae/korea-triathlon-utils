<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆë¼í†¤ êµ¬ê°„ í˜ì´ìŠ¤ ì‹œë®¬ë ˆì´í„°</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="stylesheet" href="bucheonTriStyle.css">
    <script src="menu_full_handler.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/fit-file-writer@1.0.0/dist/index.min.js"></script>
    
    <style>
        :root {
            --negative-color: #3498db;
            --even-color: #2ecc71;
            --positive-color: #e74c3c;
            --track-bg: #dfe6e9;
        }

        .slider-container { margin-bottom: 40px; position: relative; padding: 0 10px; }
        .slider-label { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 10px; color: #34495e; }
        .slider-val { color: #d35400; font-size: 1.2em; font-family: monospace; }

        input[type=range] {
            width: 100%; cursor: pointer; height: 10px; border-radius: 5px; 
            background: var(--track-bg); -webkit-appearance: none; appearance: none;
        }

        /* ì „ëµ ìŠ¬ë¼ì´ë” ê·¸ë¼ë°ì´ì…˜ ë³µêµ¬ */
        #in-strategy {
            background: linear-gradient(to right, var(--negative-color), var(--even-color), var(--positive-color)) !important;
            height: 12px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px;
            background: #fff; border: 3px solid #34495e; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* ì»¤ìŠ¤í…€ ëˆˆê¸ˆì ë³µêµ¬ */
        .custom-ruler { position: relative; width: 100%; height: 20px; margin-top: 8px; pointer-events: none; }
        .tick { position: absolute; top: 0; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; }
        .tick::before { content: ''; width: 1px; height: 8px; background: #bdc3c7; margin-bottom: 3px; }
        .tick span { font-size: 10px; color: #7f8c8d; white-space: nowrap; }
        .tick.major::before { height: 12px; background: #7f8c8d; width: 2px; }
        .tick.major span { font-weight: bold; color: #2c3e50; }

        .summary-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .sum-item span { display: block; font-size: 0.85em; color: #7f8c8d; }
        .sum-item strong { display: block; font-size: 1.2em; color: #2c3e50; margin-top: 4px; }

        .table-container { background: #fff; padding: 15px; border-radius: 12px; overflow-x: auto; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; text-align: center; }
        th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #dee2e6; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .highlight-row { background-color: #fffde7; font-weight: bold; }
        .finish-row { background-color: #e8f5e9; font-weight: bold; color: #2e7d32; }
        .garmin-section { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #e9ecef; text-align: center; }
        .btn-group { display: flex; gap: 10px; justify-content: center; }
        .btn-garmin { background: #000; color: #fff; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-csv { background: #27ae60; color: #fff; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ (Landscape) ìµœì í™” */
        @media (max-height: 600px) and (orientation: landscape) {
            body { padding-top: 40px !important; }
            .header-section { position: fixed !important; top: 0; left: 0; right: 0; height: 40px; padding: 0 15px; z-index: 999; display: flex; align-items: center; }
            .header-section h1 { font-size: 1rem; margin: 0 0 0 10px; line-height: 1; }
            .menu-btn { font-size: 1.2rem; padding: 0; }
            .container { padding-top: 10px !important; margin-top: 0 !important; }

            .controls { padding: 10px; margin-bottom: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            .slider-container { margin-bottom: 10px; }
            .slider-label { margin-bottom: 5px; font-size: 0.85em; }
            .custom-ruler { margin-top: 2px; height: 15px; }
            
            .summary-box { padding: 8px; margin-bottom: 10px; }
            .sum-item strong { font-size: 1em; }
            
            .garmin-section { padding: 10px; margin-bottom: 10px; }
            .garmin-section h3 { margin: 0 0 5px 0; font-size: 0.9em; }
            .btn-garmin, .btn-csv { padding: 6px 12px; font-size: 0.8em; }
        }

        /* ìŒì„± ì¸ì‹ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .voice-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .voice-content { background: white; width: 90%; max-width: 400px; border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; display: flex; flex-direction: column; max-height: 85vh; padding: 0; overflow: hidden; }
        .voice-close { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #999; line-height: 1; }
        .voice-mic-btn { width: 60px; height: 60px; border-radius: 50%; background: #e74c3c; color: white; border: none; font-size: 24px; margin: 10px auto; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4); transition: transform 0.2s; }
        .voice-mic-btn.listening { animation: pulse 1.5s infinite; background: #c0392b; }
        .voice-guide-box { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: left; margin-bottom: 20px; font-size: 0.9rem; color: #555; border: 1px solid #eee; }
        .voice-guide-box p { margin: 5px 0; padding-left: 10px; border-left: 3px solid #3498db; }
        .voice-status { font-weight: bold; color: #2c3e50; min-height: 24px; margin-bottom: 10px; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); transform: scale(1); }
        }
        
        .input-group-modal { margin-bottom: 10px; text-align: left; }
        .input-group-modal label { display: block; font-size: 0.85em; font-weight: bold; color: #34495e; margin-bottom: 4px; }
        .input-group-modal input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .btn-voice-open { background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 10px; }

        /* ì…ë ¥ë€ ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes flashInput {
            0% { background-color: #fff; border-color: #ddd; }
            50% { background-color: #e8f0fe; border-color: #3498db; box-shadow: 0 0 8px rgba(52, 152, 219, 0.3); }
            100% { background-color: #fff; border-color: #ddd; }
        }
        .flash-highlight { animation: flashInput 0.6s ease-out; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <button id="menuToggle" class="menu-btn" aria-label="ë©”ë‰´ ì—´ê¸°">â˜°</button>
        <h1 style="flex:1; margin-left:10px;">ğŸƒâ€â™‚ï¸ ë§ˆë¼í†¤ êµ¬ê°„ í˜ì´ìŠ¤</h1>
    </div>

    <div class="controls" style="background:#fff; padding:25px 15px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); margin-bottom:20px;">
        
        <div class="slider-container">
            <div class="slider-label"><span>ë‹¬ë¦´ ê±°ë¦¬</span><span class="slider-val"><span id="disp-dist">42.2</span> km</span></div>
            <input type="range" id="in-dist" min="5" max="42.195" step="0.005" value="42.195">
            <div class="custom-ruler">
                <div class="tick major" style="left: 0%"><span>5k</span></div>
                <div class="tick" style="left: 13.4%"><span>10k</span></div>
                <div class="tick major" style="left: 43.2%"><span>Half</span></div>
                <div class="tick" style="left: 67.2%"><span>30k</span></div>
                <div class="tick major" style="left: 100%"><span>Full</span></div>
            </div>
        </div>

        <div class="slider-container">
            <div class="slider-label"><span>ëª©í‘œ ì™„ì£¼ ì‹œê°„</span><span class="slider-val" id="disp-time">4:00:00</span></div>
            <input type="range" id="in-time" min="10" max="420" step="0.01" value="240">
            <div class="custom-ruler">
                <div class="tick major" style="left: 0%"><span>0h</span></div>
                <div class="tick" style="left: 14.3%"><span>1h</span></div>
                <div class="tick major" style="left: 28.6%"><span>2h</span></div>
                <div class="tick" style="left: 42.9%"><span>3h</span></div>
                <div class="tick major" style="left: 57.1%"><span>4h</span></div>
                <div class="tick" style="left: 71.4%"><span>5h</span></div>
                <div class="tick major" style="left: 85.7%"><span>6h</span></div>
                <div class="tick" style="left: 100%"><span>7h</span></div>
            </div>
        </div>

        <div class="slider-container">
            <div class="slider-label"><span>í‰ê·  í˜ì´ìŠ¤</span><span class="slider-val" id="disp-pace">5'41"/km</span></div>
            <input type="range" id="in-pace" min="150" max="720" step="0.01" value="341" style="direction: rtl;">
            <div style="display:flex; justify-content:space-between; font-size:0.75em; color:#95a5a6; margin-top:8px;">
                <span>ğŸ¢ Slow (12:00)</span>
                <span>ğŸš€ Fast (2:30)</span>
            </div>
        </div>

        <div class="slider-container">
            <div class="slider-label"><span>ìŠ¤í”Œë¦¿ ì „ëµ</span><span class="slider-val" id="disp-strategy">Even</span></div>
            <input type="range" id="in-strategy" min="-120" max="120" step="5" value="0">
        </div>
    </div>

    <div style="text-align: center; margin-bottom: 20px;">
        <button onclick="openVoiceModal()" style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 30px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); font-size: 1rem;">
            <span style="font-size: 1.2em;">ğŸ™ï¸</span> ìŠ¬ë¼ì´ë“œ ëŒ€ì‹  ì§ì ‘ì…ë ¥
        </button>
    </div>

    <div class="summary-box">
        <div class="sum-item"><span>ì‹œì‘ í˜ì´ìŠ¤</span><strong id="sum-start">0'00"</strong></div>
        <div class="sum-item"><span>í‰ê·  í˜ì´ìŠ¤</span><strong id="strong-avg-pace">0'00"</strong></div>
        <div class="sum-item"><span>ë§ˆì§€ë§‰ í˜ì´ìŠ¤</span><strong id="sum-end">0'00"</strong></div>
    </div>

    <div class="garmin-section">
        <h3>ê¸°ê¸°ë¡œ ì „ëµ ë‚´ë³´ë‚´ê¸°</h3>
        <div class="btn-group">
            <button class="btn-garmin" onclick="exportToFit()">FIT ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn-csv" onclick="exportToCSV()">ê°€ë¯¼ ì—…ë¡œë“œìš© CSV</button>
        </div>
        <p style="font-size: 0.8em; margin-top: 10px; color: #666;">FITì€ ê¸°ê¸°ì— ì§ì ‘ ë„£ê³ , CSVëŠ” ê°€ë¯¼ ì»¤ë„¥íŠ¸ ì›¹ì—ì„œ í™œìš©í•˜ì„¸ìš”.</p>
    </div>

    <div class="table-container">
        <table id="split-table">
            <thead><tr><th>ê±°ë¦¬(km)</th><th>êµ¬ê°„ í˜ì´ìŠ¤</th><th>ëˆ„ì  ì‹œê°„</th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

</div>

<!-- ìŒì„± ì¸ì‹ ëª¨ë‹¬ -->
<div id="voiceModal" class="voice-modal">
    <div class="voice-content">
        <div style="padding: 25px 25px 10px 25px; flex-shrink: 0; position: relative;">
            <span class="voice-close" onclick="closeVoiceModal()">&times;</span>
            <div id="voiceStatus" class="voice-status" style="font-size:1.2rem; color:#2c3e50; margin-bottom:10px; font-weight:bold; line-height:1.4;">
                ë§ˆì´í¬ë¥¼ ëˆ„ë¥´ê³  ë§í•˜ê±°ë‚˜<br>ì•„ë˜ì— ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”
            </div>
        </div>

        <div style="overflow-y: auto; padding: 0 25px 25px 25px; flex-grow: 1; -webkit-overflow-scrolling: touch;">
            <div class="modal-inputs">
                <div class="input-group-modal"><label>ê±°ë¦¬ (km)</label><input type="number" id="m-dist" step="0.001" placeholder="42.195"></div>
                <div class="input-group-modal">
                    <label>ëª©í‘œ ì‹œê°„ (ì‹œ : ë¶„ : ì´ˆ)</label>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <input type="number" id="m-time-h" placeholder="ì‹œ" style="flex:1; text-align:center;"> :
                        <input type="number" id="m-time-m" placeholder="ë¶„" style="flex:1; text-align:center;"> :
                        <input type="number" id="m-time-s" placeholder="ì´ˆ" style="flex:1; text-align:center;">
                    </div>
                </div>
                <div class="input-group-modal"><label>í˜ì´ìŠ¤ (ë¶„ ì´ˆ)</label><input type="text" id="m-pace" placeholder="5ë¶„ 41ì´ˆ"></div>
                <div class="input-group-modal"><label>ì „ëµ (ì´ˆ, -:Negative)</label><input type="number" id="m-strat" placeholder="-5"></div>
            </div>

            <div style="margin-top:20px; display:flex; align-items:center; gap:15px;">
                <button id="voiceBtn" class="voice-mic-btn" onclick="startRecognition()" style="width:60px; height:60px; font-size:28px; flex-shrink:0; margin:0;">ğŸ¤</button>
                <button onclick="applyModalValues()" style="flex:1; padding:0; background:#2ecc71; color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-size:1.1rem; height:60px;">ì ìš©í•˜ê¸°</button>
            </div>
            
            <div class="voice-guide-box" style="margin-top:15px; font-size:1rem; margin-bottom:0; padding:0; overflow:hidden;">
                <div style="padding:10px; border-bottom:1px solid #dee2e6; background:#fff; color:#555; line-height:1.4;">
                    â€» ë§ˆì´í¬ ë²„íŠ¼ì€ í•œ ë²ˆë§Œ ëˆ„ë¥´ë©´ ë“£ê¸° ëª¨ë“œê°€ ì‹œì‘ë˜ê³ , ë§ì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ì¸ì‹ì´ ì¢…ë£Œë˜ë¯€ë¡œ ê³„ì† ëˆ„ë¥¼ í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤. <span style="color:#e74c3c; font-weight:bold;">ì¸ì‹ ë‚´ìš©í™•ì¸í›„ ì ìš©í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</span>
                </div>
                <div style="padding:10px; background:#eef2f5; border-bottom:1px solid #dee2e6; font-weight:bold; color:#2c3e50; text-align:left;">
                    ğŸ’¡ ìê¸° ì•”ì‹œë¥¼ í™œìš©í•œ ë‹¤ì–‘í•œ ìŒì„±ì¸ì‹ ì˜ˆì‹œì…ë‹ˆë‹¤. 
                </div>
                <table style="width:100%; border-collapse:collapse; text-align:left;">
                <tr>
                    <th style="padding:8px 10px; background:#f8f9fa; border-bottom:1px solid #eee; color:#2c3e50; vertical-align:top;">ë¬¸ì¥í˜•</th>
                    <td style="padding:8px 10px; border-bottom:1px solid #eee;">
                        "ë‚˜ëŠ” ì„œë¸Œ ì“°ë¦¬ 5ì´ˆ ë„¤ê°€í‹°ë¸Œë¡œ ë›´ë‹¤"<br>
                        "ë‚˜ëŠ” í•˜í”„ 1ì‹œê°„ 30ë¶„ìœ¼ë¡œ ì™„ì£¼í•œë‹¤"<br>
                        "ë‚˜ëŠ” ì‹±ê¸€ì„ ë°˜ë“œì‹œ ë‹¬ì„±í•œë‹¤"
                    </td>
                </tr>
                <tr>
                    <th style="padding:8px 10px; background:#f8f9fa; border-bottom:1px solid #eee; width:60px; color:#2c3e50; vertical-align:top;">ê´€ìš©ì–´</th>
                    <td style="padding:8px 10px; border-bottom:1px solid #eee;">"ì´ì‚¬êµ¬", "ì„œë¸Œ ì“°ë¦¬", "ì‹±ê¸€", "ì‚¼ì´ê³µ", "ì‚¼ì‚¼ê³µ", "ì„œë¸Œ í¬", "ì‚¬ì‚¼ê³µ", "ì„œë¸Œ íŒŒì´ë¸Œ"</td>
                </tr>
                <tr>
                    <th style="padding:8px 10px; background:#f8f9fa; border-bottom:1px solid #eee; color:#2c3e50; vertical-align:top;">ë‹¨ì¶•í˜•</th>
                    <td style="padding:8px 10px; border-bottom:1px solid #eee;">"10í‚¤ë¡œ 50ë¶„", "í•˜í”„ 1ì‹œê°„ 30ë¶„"</td>
                </tr>
                <tr>
                    <th style="padding:8px 10px; background:#f8f9fa; color:#2c3e50; vertical-align:top;">ê¸°íƒ€</th>
                    <td style="padding:8px 10px;">"15í‚¤ë¡œ 5ë¶„ 30ì´ˆ í˜ì´ìŠ¤", "3ì‹œê°„ 40ë¶„"</td>
                </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const elDist = document.getElementById('in-dist'), elTime = document.getElementById('in-time');
    const elPace = document.getElementById('in-pace'), elStrat = document.getElementById('in-strategy');
    const dDist = document.getElementById('disp-dist'), dTime = document.getElementById('disp-time');
    const dPace = document.getElementById('disp-pace'), dStrat = document.getElementById('disp-strategy');
    const sStart = document.getElementById('sum-start'), sAvg = document.getElementById('strong-avg-pace'), sEnd = document.getElementById('sum-end');

    let currentSplits = [];

    function fmtPace(sec) {
        let totalSec = Math.round(sec);
        let m = Math.floor(totalSec / 60), s = totalSec % 60;
        return `${m}'${s.toString().padStart(2, '0')}"`;
    }
    function fmtPaceKr(sec) {
        let totalSec = Math.round(sec);
        let m = Math.floor(totalSec / 60), s = totalSec % 60;
        return `${m}ë¶„ ${s}ì´ˆ`;
    }
    function fmtTotalTime(min) {
        let totalSec = Math.round(min * 60);
        let h = Math.floor(totalSec / 3600), m = Math.floor((totalSec % 3600) / 60), s = totalSec % 60;
        return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function update() {
        const d = parseFloat(elDist.value), p = parseFloat(elPace.value), st = parseFloat(elStrat.value);
        const totalMin = (d * p) / 60;
        currentSplits = [];

        dDist.textContent = Number(d.toFixed(3));
        dTime.textContent = fmtTotalTime(totalMin);
        dPace.textContent = fmtPace(p) + "/km";

        dStrat.textContent = st === 0 ? "Even" : (st < 0 ? `Negative (${Math.abs(st)}s)` : `Positive (${st}s)`);
        dStrat.style.color = st === 0 ? "var(--even-color)" : (st < 0 ? "var(--negative-color)" : "var(--positive-color)");

        let startP = p - (st / 2), endP = p + (st / 2);
        sStart.textContent = fmtPace(startP);
        sAvg.textContent = fmtPace(p);
        sEnd.textContent = fmtPace(endP);

        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";
        let cumS = 0, slope = (d > 1) ? st / (d - 1) : 0;
        
        for (let i = 1; i <= Math.floor(d); i++) {
            let curP = startP + ((i - 1) * slope);
            cumS += curP;
            currentSplits.push({km: i, pace: curP, cumulative: cumS});

            let tr = document.createElement('tr');
            if(i % 5 === 0) tr.className = 'highlight-row';
            tr.innerHTML = `<td>${i} km</td><td>${fmtPace(curP)}</td><td>${fmtTotalTime(cumS/60)}</td>`;
            tbody.appendChild(tr);
        }
        if (d % 1 > 0) {
            let lastP = startP + (Math.floor(d) * slope);
            cumS += lastP * (d % 1);
            let tr = document.createElement('tr');
            tr.className = 'finish-row';
            tr.innerHTML = `<td>Finish (${d}km)</td><td>${fmtPace(lastP)}</td><td>${fmtTotalTime(cumS/60)}</td>`;
            tbody.appendChild(tr);
        }
    }
    // CSV ë‚´ë³´ë‚´ê¸° (ì•ˆì „í•œ ëŒ€ì²´ ë°©ë²•)
    function exportToCSV() {
        let csvContent = "Distance,Target Pace,Cumulative Time\n";
        currentSplits.forEach(s => {
            csvContent += `${s.km},${fmtPace(s.pace)},${new Date(s.cumulative * 1000).toISOString().substr(11, 8)}\n`;
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "marathon_strategy.csv";
        link.click();
    }

    // FIT ë‚´ë³´ë‚´ê¸° ìˆ˜ì •
    function exportToFit() {
        // ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¡´ì¬ ì—¬ë¶€ ë‹¤ì‹œ í™•ì¸
        const FitWriter = window.FitFileWriter || (window.default && window.default.FitFileWriter);
        
        if (!FitWriter) {
            alert("ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨. CSV ê¸°ëŠ¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            const writer = new FitWriter();
            // ê°€ë¯¼ì´ ì¸ì‹í•  ìˆ˜ ìˆëŠ” ìµœì†Œí•œì˜ ì„¸ì…˜ ì •ë³´ ì¶”ê°€
            currentSplits.forEach(s => {
                writer.addRecord({
                    timestamp: new Date(),
                    distance: s.km * 1000,
                    enhanced_speed: 1000 / s.pace // m/s
                });
            });

            const blob = new Blob([writer.write()], { type: 'application/octet-stream' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "PacePro_Strategy.fit";
            link.click();
        } catch (e) {
            console.error(e);
            alert("FIT íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        }
    }


    elDist.oninput = () => { elTime.value = (elDist.value * elPace.value) / 60; update(); };
    elTime.oninput = () => { elPace.value = (elTime.value * 60) / elDist.value; update(); };
    elPace.oninput = () => { elTime.value = (elDist.value * elPace.value) / 60; update(); };
    elStrat.oninput = update;
    update();

    // --- ìŒì„± ì¸ì‹ ê¸°ëŠ¥ ---
    const voiceModal = document.getElementById('voiceModal');
    const voiceStatus = document.getElementById('voiceStatus');
    const voiceBtn = document.getElementById('voiceBtn');
    let recognition = null;

    function openVoiceModal() { 
        // í˜„ì¬ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
        document.getElementById('m-dist').value = elDist.value;
        const totalMin = parseFloat(elTime.value);
        document.getElementById('m-time-h').value = Math.floor(totalMin / 60);
        document.getElementById('m-time-m').value = Math.floor(totalMin % 60);
        document.getElementById('m-time-s').value = Math.round((totalMin * 60) % 60);
        
        document.getElementById('m-pace').value = fmtPaceKr(elPace.value);
        document.getElementById('m-strat').value = elStrat.value;
        voiceStatus.innerText = "ë§ˆì´í¬ë¥¼ ëˆ„ë¥´ê³  ë§í•˜ê±°ë‚˜\nì•„ë˜ì— ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”";
        voiceModal.style.display = 'flex'; 
    }
    function closeVoiceModal() { 
        voiceModal.style.display = 'none'; 
        if(recognition) recognition.stop();
    }

    function startRecognition() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ê¶Œì¥)");
            return;
        }

        recognition = new webkitSpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = function() {
            voiceBtn.classList.add('listening');
            voiceStatus.innerText = "ë“£ê³  ìˆìŠµë‹ˆë‹¤...";
        };

        recognition.onend = function() {
            voiceBtn.classList.remove('listening');
        };

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            voiceStatus.innerText = `ì¸ì‹ë¨: "${transcript}"`;
            parseToModal(transcript);
        };

        recognition.start();
    }

    function highlightElement(id) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('flash-highlight');
            void el.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ ë°œìƒ (ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘ìš©)
            el.classList.add('flash-highlight');
        }
    }

    function parseToModal(text) {
        let dist = null, time = null, pace = null, strat = null;

        // 1. ê±°ë¦¬ íŒŒì‹±
        if (text.includes("í•˜í”„")) dist = 21.0975;
        else if (text.includes("í’€") || text.includes("ì„œë¸Œ") || text.includes("ì‹±ê¸€") || text.includes("ì‚¼ì‚¼ê³µ") || text.includes("ì´ì‚¬êµ¬")) dist = 42.195;
        else if ((text.includes("330") || text.includes("249")) && !text.includes("ë¶„")) dist = 42.195; // ìˆ«ìë§Œ ìˆëŠ” ê´€ìš©êµ¬ ì²˜ë¦¬
        else {
            const distMatch = text.match(/(\d+(?:\.\d+)?)\s*í‚¤ë¡œ/);
            if (distMatch) dist = parseFloat(distMatch[1]);
        }

        // 2. ì‹œê°„ íŒŒì‹± (ê´€ìš©êµ¬ ë° ì¼ë°˜ ì‹œê°„)
        if (text.includes("ì„œë¸Œ ì“°ë¦¬") || text.includes("ì„œë¸Œ 3") || text.includes("ì„œë¸Œ3")) {
            time = 180; // 3ì‹œê°„
        } else if (text.includes("ì„œë¸Œ í¬") || text.includes("ì„œë¸Œ 4") || text.includes("ì„œë¸Œ4")) {
            time = 240; // 4ì‹œê°„
        } else if (text.includes("ì‹±ê¸€")) {
            time = 189; // 3ì‹œê°„ 9ë¶„
        } else if (text.includes("ì‚¼ì‚¼ê³µ") || (text.includes("330") && !text.includes("ë¶„"))) {
            time = 210; // 3ì‹œê°„ 30ë¶„
        } else if (text.includes("ì´ì‚¬êµ¬") || (text.includes("249") && !text.includes("ë¶„"))) {
            time = 169; // 2ì‹œê°„ 49ë¶„
        } else if (text.includes("ì‚¼ì´ê³µ") || (text.includes("320") && !text.includes("ë¶„"))) {
            time = 200; // 3ì‹œê°„ 20ë¶„
        } else if (text.includes("ì‚¬ì‚¼ê³µ") || (text.includes("430") && !text.includes("ë¶„"))) {
            time = 270; // 4ì‹œê°„ 30ë¶„
        } else if (text.includes("ì„œë¸Œ íŒŒì´ë¸Œ") || text.includes("ì„œë¸Œ 5") || text.includes("ì„œë¸Œ5")) {
            time = 300; // 5ì‹œê°„
        } else {
            const timeMatch = text.match(/(\d+)\s*ì‹œê°„\s*(?:(\d+)\s*ë¶„)?/);
            if (timeMatch) {
                time = parseInt(timeMatch[1]) * 60 + (timeMatch[2] ? parseInt(timeMatch[2]) : 0);
            } else {
                // "30ë¶„ìœ¼ë¡œ" ì²˜ëŸ¼ ë¶„ë§Œ ìˆëŠ” ê²½ìš° (í˜ì´ìŠ¤ì™€ êµ¬ë¶„ í•„ìš”: ë³´í†µ 10ë¶„ ì´ìƒì´ë©´ ì‹œê°„ìœ¼ë¡œ ê°„ì£¼)
                const minMatch = text.match(/(\d+)\s*ë¶„(?!.*ì´ˆ)/); // ì´ˆê°€ ë’¤ì— ì—†ì–´ì•¼ í•¨
                if (minMatch && parseInt(minMatch[1]) > 15) time = parseInt(minMatch[1]);
            }
        }

        // 3. í˜ì´ìŠ¤ íŒŒì‹± (ë¶„ ì´ˆ)
        const paceMatch = text.match(/(\d+)\s*ë¶„\s*(\d+)\s*ì´ˆ/);
        if (paceMatch) {
            pace = parseInt(paceMatch[1]) * 60 + parseInt(paceMatch[2]);
        }

        // 4. ì „ëµ íŒŒì‹± (ë„¤ê°€í‹°ë¸Œ/í¬ì§€í‹°ë¸Œ)
        const stratMatch = text.match(/(\d+)\s*ì´ˆ\s*(ë„¤ê°€í‹°ë¸Œ|ë„¤ê±°í‹°ë¸Œ|í¬ì§€í‹°ë¸Œ|íŒŒì§€í‹°ë¸Œ)/);
        if (stratMatch) {
            const val = parseInt(stratMatch[1]);
            const type = stratMatch[2];
            strat = (type.includes("ë„¤") ? -1 : 1) * val;
        }

        // ëª¨ë‹¬ ì…ë ¥ì°½ì— ê°’ ì ìš©
        if (dist !== null) {
            document.getElementById('m-dist').value = dist;
            highlightElement('m-dist');
        }
        
        // ì‹œê°„/í˜ì´ìŠ¤ ê³„ì‚° ë¡œì§ (ê±°ë¦¬ì™€ ì‹œê°„/í˜ì´ìŠ¤ê°€ ìˆìœ¼ë©´ ë‚˜ë¨¸ì§€ í•˜ë‚˜ ê³„ì‚°)
        let currentDist = dist !== null ? dist : parseFloat(document.getElementById('m-dist').value);
        
        if (time !== null) {
            document.getElementById('m-time-h').value = Math.floor(time / 60);
            document.getElementById('m-time-m').value = Math.floor(time % 60);
            document.getElementById('m-time-s').value = Math.round((time * 60) % 60);
            highlightElement('m-time-h');
            highlightElement('m-time-m');
            highlightElement('m-time-s');
            
            if(currentDist > 0) {
                document.getElementById('m-pace').value = fmtPaceKr((time * 60) / currentDist);
                highlightElement('m-pace');
            }
        } else if (pace !== null) {
            document.getElementById('m-pace').value = fmtPaceKr(pace);
            highlightElement('m-pace');
            if(currentDist > 0) {
                const tVal = (currentDist * pace) / 60;
                document.getElementById('m-time-h').value = Math.floor(tVal / 60);
                document.getElementById('m-time-m').value = Math.floor(tVal % 60);
                document.getElementById('m-time-s').value = Math.round((tVal * 60) % 60);
                highlightElement('m-time-h');
                highlightElement('m-time-m');
                highlightElement('m-time-s');
            }
        }
        
        if (strat !== null) {
            document.getElementById('m-strat').value = strat;
            highlightElement('m-strat');
        }
    }

    function applyModalValues() {
        const d = parseFloat(document.getElementById('m-dist').value);
        const hVal = document.getElementById('m-time-h').value;
        const mVal = document.getElementById('m-time-m').value;
        const sVal = document.getElementById('m-time-s').value;
        const pStr = document.getElementById('m-pace').value;
        const s = parseFloat(document.getElementById('m-strat').value);

        let targetDist = parseFloat(elDist.value);
        let targetTime = parseFloat(elTime.value);
        let targetPace = parseFloat(elPace.value);
        let targetStrat = parseFloat(elStrat.value);

        if(!isNaN(d)) targetDist = d;
        
        // ì‹œê°„ íŒŒì‹± (H, M, S -> min)
        let tMin = 0;
        if (hVal !== "" || mVal !== "" || sVal !== "") {
            tMin = (parseInt(hVal) || 0) * 60 + (parseInt(mVal) || 0) + (parseFloat(sVal) || 0) / 60;
        }
        
        if(tMin > 0) {
            targetTime = tMin;
            // í˜ì´ìŠ¤ ìë™ ê³„ì‚° (ì‹œê°„ ìš°ì„ )
            targetPace = (tMin * 60) / targetDist;
        } else {
            // í˜ì´ìŠ¤ íŒŒì‹± (í•œê¸€ "ë¶„ ì´ˆ" ë˜ëŠ” MM'SS" -> sec)
            let pSec = 0;
            if (pStr.includes("ë¶„") || pStr.includes("ì´ˆ")) {
                const pMatch = pStr.match(/(\d+)\s*ë¶„\s*(?:(\d+)\s*ì´ˆ)?/);
                if (pMatch) {
                    pSec = parseInt(pMatch[1]) * 60 + (pMatch[2] ? parseInt(pMatch[2]) : 0);
                }
            } else {
                const pClean = pStr.replace(/["']/g, ':');
                const pParts = pClean.split(':').map(Number);
                if(pParts.length >= 2) pSec = pParts[0]*60 + pParts[1];
                else pSec = parseFloat(pClean) || 0;
            }
            
            if(pSec > 0) {
                targetPace = pSec;
                targetTime = (targetDist * pSec) / 60;
            }
        }

        if(!isNaN(s)) targetStrat = s;
        
        closeVoiceModal();
        animateChanges(targetDist, targetTime, targetPace, targetStrat);
    }

    function animateChanges(tDist, tTime, tPace, tStrat) {
        // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ì¡°ì‘ ë°©ì§€
        [elDist, elTime, elPace, elStrat].forEach(el => el.disabled = true);

        const startDist = parseFloat(elDist.value);
        const startTime = parseFloat(elTime.value);
        const startPace = parseFloat(elPace.value);
        const startStrat = parseFloat(elStrat.value);

        const duration = 1000; // 1ì´ˆ ë™ì•ˆ ë¶€ë“œëŸ½ê²Œ ì´ë™
        const startTimeStamp = performance.now();

        function step(currentTime) {
            const elapsed = currentTime - startTimeStamp;
            const progress = Math.min(elapsed / duration, 1);
            const ease = 1 - Math.pow(1 - progress, 3); // Ease Out Cubic

            elDist.value = startDist + (tDist - startDist) * ease;
            elTime.value = startTime + (tTime - startTime) * ease;
            elPace.value = startPace + (tPace - startPace) * ease;
            elStrat.value = startStrat + (tStrat - startStrat) * ease;

            update();

            if (progress < 1) {
                requestAnimationFrame(step);
            } else {
                // ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ í›„ ì¡°ì‘ í™œì„±í™” ë° ìš”ì•½ ë°•ìŠ¤ ê°•ì¡°
                [elDist, elTime, elPace, elStrat].forEach(el => el.disabled = false);
                highlightSummary();
            }
        }
        requestAnimationFrame(step);
    }

    function highlightSummary() {
        const targets = [sStart, sAvg, sEnd];
        targets.forEach(el => {
            el.style.transition = "color 0.3s, transform 0.3s";
            el.style.color = "#e74c3c"; // ê°•ì¡°ìƒ‰ (ë¶‰ì€ìƒ‰)
            el.style.transform = "scale(1.2)";
        });
        setTimeout(() => {
            targets.forEach(el => {
                el.style.color = ""; 
                el.style.transform = "scale(1)";
            });
        }, 800);
    }

    // PWA ë’¤ë¡œê°€ê¸° 2ë²ˆ ì¢…ë£Œ ë¡œì§
    (function() {
        let lastBackPressTime = 0;
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', function() {
            const now = new Date().getTime();
            if (now - lastBackPressTime < 2000) { history.back(); return; }
            lastBackPressTime = now;
            history.pushState(null, null, location.href);
            const t = document.createElement('div');
            t.innerText = "'ë’¤ë¡œ' ë²„íŠ¼ì„ í•œë²ˆ ë” ëˆ„ë¥´ë©´ ì¢…ë£Œë©ë‹ˆë‹¤.";
            Object.assign(t.style, {
                position:'fixed', bottom:'20px', left:'50%', transform:'translateX(-50%)',
                background:'rgba(0,0,0,0.7)', color:'#fff', padding:'10px 20px',
                borderRadius:'20px', zIndex:9999, fontSize:'0.9rem', pointerEvents:'none'
            });
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        });
    })();
</script>
</body>
</html>