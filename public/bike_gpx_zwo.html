<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Ride Workout Hub</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="bucheonTriStyle.css">
    <script src="menu_full_handler.js" defer></script>
    <script src="back_exit_handler.js" defer></script>
    <style>
        :root { 
            --zwift-orange: #fc6719; --strava-red: #fc4c02; --mywhoosh-yellow: #f6c303;
            --panel-bg: #ffffff; --text-main: #333; --text-sub: #666; --border-color: #e0e0e0;
        }

        /* Body styling handled by bucheonTriStyle.css */
        
        .content-wrapper {
            max-width: 1300px; margin: 0 auto; width: 100%;
        }

        /* Header and h1 handled by bucheonTriStyle.css */

        .step-container { 
            background: var(--panel-bg); border-radius: 16px; padding: 20px; margin-bottom: 25px; 
            border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        }
        .step-1 { border-top: 5px solid var(--strava-red); }
        .step-2 { border-top: 5px solid var(--zwift-orange); }
        .step-3 { border-top: 5px solid #4CAF50; }
        .step-4 { border-top: 5px solid var(--mywhoosh-yellow); }

        .step-title { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .step-number { background: #eee; color: #555; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: bold; }

        .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        a.button, .content-wrapper button, .modal button { 
            display: inline-flex; align-items: center; justify-content: center; padding: 12px 16px; 
            background-color: #f0f0f0; color: #333; text-decoration: none; border-radius: 10px; 
            border: 1px solid #ddd; cursor: pointer; font-weight: 600; flex: 1; min-width: 140px; transition: 0.2s;
        }
        a.button:hover, .content-wrapper button:hover, .modal button:hover { background-color: #e5e5e5; transform: translateY(-1px); }
        .btn-primary { background-color: #333 !important; color: white !important; border: none !important; }

        /* GPX ê³ ì €ë„ ì°¨íŠ¸ */
        #elevationWrapper { display: none; margin-top: 20px; padding: 15px; background: #fafafa; border-radius: 12px; border: 1px solid #eee; }
        .chart-container { background: #fff; border-radius: 10px; padding: 10px; border: 1px solid #eee; margin-top: 10px; }

        /* ë¶„ì„ ê²°ê³¼ ì˜ì—­ */
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .stat-group { background: #fdfdfd; border-radius: 12px; padding: 15px; border: 1px solid #eee; }
        .stat-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dotted #ddd; font-size: 0.9rem; }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: var(--text-sub); }
        .stat-value { font-weight: 700; color: #111; }

        input[type="number"], input[type="file"] { 
            border: 1px solid #ddd; padding: 10px; border-radius: 8px; font-size: 0.95rem; 
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; border-radius: 20px; width: 85%; max-width: 550px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }

        /* ğŸ“± ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 600px) {
            .stats-container { grid-template-columns: 1fr; }
            .button-group { flex-direction: column; }
            .button { width: 100%; }

            /* ëª¨ë‹¬ ëª¨ë°”ì¼ ìµœì í™” */
            .modal-content { margin: 20% auto; width: 90%; padding: 20px; max-height: 75vh; }
            .modal-content div { font-size: 0.85rem !important; line-height: 1.5 !important; }
            .modal-content h3 { font-size: 1.1rem !important; }
            .modal-content h4 { font-size: 0.95rem !important; margin-top: 15px !important; }
            .modal button { height: 40px !important; font-size: 0.9rem !important; margin-top: 15px !important; padding: 0 !important; }
        }

        /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ (Landscape) ìµœì í™” */
        @media (max-height: 600px) and (orientation: landscape) {
            body { padding-top: 40px !important; }
            .header-section { position: fixed !important; top: 0; left: 0; right: 0; height: 40px; padding: 0 15px; z-index: 999; display: flex; align-items: center; }
            .header-section h1 { font-size: 1rem; margin: 0 0 0 10px; line-height: 1; }
            .menu-btn { font-size: 1.2rem; padding: 0; }
            .container { padding-top: 10px !important; margin-top: 0 !important; }
            
            .step-container { padding: 10px; margin-bottom: 15px; }
            .step-title { font-size: 1rem; margin-bottom: 8px; }
            .chart-container { height: 150px !important; }
            
            .stats-container { grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
            .stat-group { padding: 8px; }
            .stat-row { padding: 3px 0; font-size: 0.8rem; }
            
            .button-group { gap: 5px; margin-top: 5px; }
            a.button, .content-wrapper button { padding: 8px 12px; min-width: auto; font-size: 0.9rem; }
        }

        /* ê°€ì´ë“œ ëª¨ë‹¬ ë””ìì¸ ê°œì„  */
        .guide-box { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ddd; }
        .guide-box h4 { margin: 0 0 8px 0; font-size: 1rem; }
        .guide-box p, .guide-box li { font-size: 0.9rem; color: #444; margin: 4px 0; line-height: 1.5; }
        .guide-box ul, .guide-box ol { padding-left: 20px; margin: 5px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <button id="menuToggle" class="menu-btn" aria-label="ë©”ë‰´ ì—´ê¸°">â˜°</button>
        <h1>ğŸš´ Ride Workout Hub</h1>
    </div>

    <div class="content-wrapper">
        <p style="color: var(--text-sub); font-size: 0.9rem; text-align: center; margin-bottom: 20px;">ì•¼ì™¸ GPX ê¸°ë¡ì„ ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ë³€í™˜í•˜ì„¸ìš”.</p>

    <div class="step-container step-1">
        <div class="step-title"><div class="step-number">1</div>Strava GPX ì¶”ì¶œ ë° í™•ì¸</div>
        <p style="font-size: 0.9rem; margin-bottom: 10px;">ìŠ¤íŠ¸ë¼ë°”ì—ì„œ ê²½ë¡œ íŒŒì¼ì„ ì¤€ë¹„í•˜ê³  ë¯¸ë¦¬ë³´ê¸°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        <div class="button-group">
            <a href="https://www.strava.com/athlete/training" target="_blank" class="button btn-primary" style="background:var(--strava-red) !important;">Strava ì—´ê¸°</a>
        </div>
        <div style="margin-top: 15px;">
            <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 0.85rem; font-weight: bold;">GPX íŒŒì¼ ì„ íƒ (ê³ ì €ë„ í™•ì¸):</span>
                <a href="ë¶€ì²œíŠ¸ë¼ì´_ì•„ë¼ë±ƒê¸¸_ë¼ì´ë”©í›ˆë ¨_51km.gpx" download="ë¶€ì²œíŠ¸ë¼ì´_ì•„ë¼ë±ƒê¸¸_ë¼ì´ë”©í›ˆë ¨_51km.gpx" style="font-size: 0.8rem; font-weight: normal;">ìƒ˜í”ŒíŒŒì¼ë‹¤ìš´</a>
            </label>
            <input type="file" id="gpxInput" accept=".gpx" style="width: 100%; box-sizing: border-box;">
        </div>

        <div id="elevationWrapper">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: bold; font-size: 0.9rem;">â›°ï¸ ì½”ìŠ¤ ê³ ì €ë„ ë¯¸ë¦¬ë³´ê¸°</span>
                <span id="gpxInfo" style="font-size: 0.8rem; color: var(--strava-red); font-weight: bold;"></span>
            </div>
            <div class="chart-container" style="height: 180px;">
                <canvas id="elevationChart"></canvas>
            </div>
        </div>
    </div>

    <div class="step-container step-2">
        <div class="step-title"><div class="step-number">2</div>ZWO ë³€í™˜</div>
        <p style="font-size: 0.9rem; margin-bottom: 10px;">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ .zwo ì›Œí¬ì•„ì›ƒ íŒŒì¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.</p>
        <div class="button-group">
            <a href="https://whatsonzwift.com/gpx-to-zwift-workout" target="_blank" class="button btn-primary" style="background:var(--zwift-orange) !important;">ZWO ì»¨ë²„í„° ì—´ê¸°</a>
            <button onclick="openModal()">ğŸ’¡ ì„¤ì • ê°€ì´ë“œ ë³´ê¸°</button>
        </div>
    </div>

    <div class="step-container step-3">
        <div class="step-title"><div class="step-number">3</div>ë¶„ì„ ë° ìµœì í™”</div>
        <div style="background: #f1f3f5; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
            <div>ë‚´ FTP <input type="number" id="ftpInput" value="200" style="width:65px;"> W</div>
            <div>ë‚´ ì²´ì¤‘ <input type="number" id="weightInput" value="70" style="width:65px;"> kg</div>
        </div>
        
        <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-size: 0.85rem; font-weight: bold;">ë³€í™˜ëœ ZWO íŒŒì¼ ì—…ë¡œë“œ:</span>
            <a href="ë¶€ì²œíŠ¸ë¼ì´_ì•„ë¼ë±ƒê¸¸_ë¼ì´ë”©í›ˆë ¨_51km.zwo" download="ë¶€ì²œíŠ¸ë¼ì´_ì•„ë¼ë±ƒê¸¸_ë¼ì´ë”©í›ˆë ¨_51km.zwo" style="font-size: 0.8rem; font-weight: normal;">ìƒ˜í”ŒíŒŒì¼ë‹¤ìš´</a>
        </label>
        <input type="file" id="zwoInput" accept=".zwo" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">
        
        <div id="resultArea" style="display:none;">
            <div class="stats-container">
                <div class="stat-group">
                    <div class="stat-row"><span class="stat-label">Time (ì´ ì‹œê°„)</span><span class="stat-value" id="resTime">-</span></div>
                    <div class="stat-row"><span class="stat-label">NPÂ® (ì •ê·œí™” íŒŒì›Œ)</span><span class="stat-value" id="resNP">-</span></div>
                    <div class="stat-row"><span class="stat-label">IFÂ® (ê°•ë„ ì§€ìˆ˜)</span><span class="stat-value" id="resIF">-</span></div>
                </div>
                <div class="stat-group">
                    <div class="stat-row"><span class="stat-label">Avg. Power (í‰ê· )</span><span class="stat-value" id="resAvgP">-</span></div>
                    <div class="stat-row"><span class="stat-label">TSSÂ® (í›ˆë ¨ ë¶€í•˜)</span><span class="stat-value" id="resTSS">-</span></div>
                    <div class="stat-row"><span class="stat-label">W/kg (ì²´ì¤‘ë¹„)</span><span class="stat-value" id="resWkg">-</span></div>
                </div>
            </div>
            <div class="chart-container" style="height: 280px; margin-top: 15px;">
                <canvas id="workoutChart"></canvas>
            </div>
            <button id="downloadBtn" class="btn-primary" style="width:100%; margin-top:20px; height: 55px; background: #4CAF50 !important; font-size: 1.1rem;">ë§ˆì´ìš°ì‰¬ í˜¸í™˜ ZWO ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <div class="step-container step-4">
        <div class="step-title"><div class="step-number">4</div>ê²Œì„ í´ë” ë°°í¬</div>
        <p style="font-size:0.85rem; color:var(--text-sub); margin-bottom:10px;">ê° ê²Œì„ì˜ ì›Œí¬ì•„ì›ƒ í´ë” ê²½ë¡œì…ë‹ˆë‹¤. í´ë¦­í•˜ì—¬ ë³µì‚¬ í›„ íƒìƒ‰ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
        
        <div class="button-group" style="margin-bottom: 15px;">
            <button onclick="openDeployGuideModal()">ğŸ“– ë°°í¬ ê°€ì´ë“œ ë³´ê¸°</button>
        </div>

        <div class="path-card">
            <div class="path-title" style="color:var(--mywhoosh-yellow);">ğŸŸ¡ MyWhoosh ê²½ë¡œ</div>
            <span class="path-text" id="p_mywhoosh">%USERPROFILE%\Documents\MyWhoosh\Workouts</span>
            <button onclick="copyT('p_mywhoosh')" style="margin-top:8px; width:100%; padding:8px;">ë§ˆì´ìš°ì‰¬ ê²½ë¡œ ë³µì‚¬</button>
        </div>

        <div class="path-card" style="margin-top:15px;">
            <div class="path-title" style="color:var(--zwift-orange);">ğŸŸ  Zwift ê²½ë¡œ</div>
            <span class="path-text" id="p_zwift">%USERPROFILE%\Documents\Zwift\Workouts</span>
            <button onclick="copyT('p_zwift')" style="margin-top:8px; width:100%; padding:8px;">ì¦ˆìœ„í”„íŠ¸ ê²½ë¡œ ë³µì‚¬</button>
        </div>
    </div>
</div>

    <div id="gModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                <h3 style="margin: 0;">ğŸ“‹ ZWO ì»¨ë²„í„° ì„¤ì • ê°€ì´ë“œ</h3>
                <span onclick="closeModal()" style="font-size: 24px; cursor: pointer; color: #999;">&times;</span>
            </div>
            <div class="guide-box" style="border-left-color: var(--zwift-orange);">
                <h4 style="color: var(--zwift-orange);">1. ê¸°ë³¸ ì„¤ì • (Rider data)</h4>
                <p>â€¢ <b>FTP:</b> ì •í™•í•œ íŒŒì›Œë¥¼ ì…ë ¥í•´ì•¼ í›ˆë ¨ ê°•ë„ê°€ ë§ìŠµë‹ˆë‹¤.</p>
                <p>â€¢ <b>Target intensity factor (IF):</b> <b>0.8</b> ì •ë„ê°€ ê°€ì¥ ì ë‹¹í•©ë‹ˆë‹¤.</p>
                <p>â€¢ <b>Mass:</b> ë¼ì´ë”ì™€ ìì „ê±° ë¬´ê²Œë¥¼ ê°ê° ì…ë ¥í•˜ì„¸ìš”.</p>
            </div>
            <div class="guide-box" style="border-left-color: #555;">
                <h4 style="color: #333;">2. ê³ ê¸‰ ì„¤ì • (Advanced)</h4>
                <p>â€¢ <b>CdA (ê³µê¸°ì €í•­):</b> ë³´í†µ 0.3ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
                <p>â€¢ <b>Drivetrain loss:</b> ê¸°ì–´ ì†ì‹¤ íŒŒì›Œ(ì•½ 3%)ì…ë‹ˆë‹¤.</p>
                <p>â€¢ <b>Warm-up:</b> ì‹œì‘ ì „ 10ë¶„ê°„ì˜ ëª¸í’€ê¸° êµ¬ê°„ ì¶”ê°€ ì—¬ë¶€ì…ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <div id="deployGuideModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                <h3 style="margin: 0;">ğŸ“– ZWO íŒŒì¼ ë°°í¬ ê°€ì´ë“œ</h3>
                <span onclick="closeDeployGuideModal()" style="font-size: 24px; cursor: pointer; color: #999;">&times;</span>
            </div>
            
            <div class="guide-box" style="border-left-color: var(--mywhoosh-yellow);">
                <h4 style="color: #d4a017;">ğŸŸ¡ MyWhoosh íŒŒì¼ ë°°í¬</h4>
                <p>ì¦ˆìœ„í”„íŠ¸ íŒŒì¼(.zwo)ì„ êµ¬í•˜ì…¨ë‹¤ë©´, ë§ˆì´ìš°ì‰¬ê°€ ì„¤ì¹˜ëœ PCì˜ ì•„ë˜ ê²½ë¡œì— ë³µì‚¬í•´ì„œ ë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤.</p>
                <p><b>ê²½ë¡œ:</b> <code style="background:#eee; padding: 2px 5px; border-radius:4px;">C:\Users\[ì‚¬ìš©ìëª…]\Documents\MyWhoosh\Workouts</code></p>
                
                <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #ccc;">
                    <strong>ğŸ“± ëª¨ë°”ì¼/íƒœë¸”ë¦¿ ìœ ì € íŒ</strong>
                    <ul style="margin-top:5px;">
                        <li><b>PC ê²½ìœ :</b> PCë²„ì „ì—ì„œ í•œë²ˆ ë¡œë“œí•˜ë©´ í´ë¼ìš°ë“œ ë™ê¸°í™”ë¨</li>
                        <li><b>ì›¹ ì—ë””í„°:</b> MyWhoosh ê³µì‹ ì›¹ì‚¬ì´íŠ¸ ì—ë””í„°ë¡œ Import ê°€ëŠ¥</li>
                    </ul>
                </div>
            </div>

            <div class="guide-box" style="border-left-color: var(--zwift-orange);">
                <h4 style="color: var(--zwift-orange);">ğŸŸ  ì¦ˆìœ„í”„íŠ¸ íŒŒì¼ ë°°í¬</h4>
                <p>ë§ˆì´ìš°ì‰¬ëŠ” í´ë¼ìš°ë“œ ê¸°ë°˜ì´ì§€ë§Œ, ì¦ˆìœ„í”„íŠ¸ëŠ” PCì˜ íŠ¹ì • í´ë”ì— íŒŒì¼ì´ ìƒê¸°ë©´ ê·¸ê±¸ ì„œë²„ë¡œ ì˜¬ë¦¬ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.</p>
                <ul style="margin-top:5px;">
                    <li><b>ê²½ë¡œ:</b> <code>\Documents\Zwift\Workouts</code></li>
                    <li>PCì—ì„œ ì¸ì‹ì‹œí‚¤ë©´, ì¶”í›„ ì•„ì´íŒ¨ë“œ/ì• í”ŒTV ë“±ì—ì„œë„ 'Custom Workouts'ì— ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let elevChart = null; let workChart = null; let parsedSegs = []; let fName = ""; let map = null; let polyline = null;

        // --- GPX ê³ ì €ë„ ë¯¸ë¦¬ë³´ê¸° ë¡œì§ ---
        document.getElementById('gpxInput').onchange = function(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                const xml = new DOMParser().parseFromString(ev.target.result, "text/xml");
                const pts = xml.getElementsByTagName("trkpt");
                let data = [], totalD = 0, pLat, pLon; let pathCoords = [];
                for (let i = 0; i < pts.length; i++) {
                    const ele = parseFloat(pts[i].getElementsByTagName("ele")[0]?.textContent || 0);
                    const lat = parseFloat(pts[i].getAttribute("lat")), lon = parseFloat(pts[i].getAttribute("lon"));
                    if (i > 0) totalD += haversine(pLat, pLon, lat, lon);
                    data.push({ x: totalD.toFixed(2), y: ele });
                    pathCoords.push({ lat: lat, lng: lon });
                    pLat = lat; pLon = lon;
                }
                drawElev(data);

                document.getElementById('elevationWrapper').style.display = 'block';
                document.getElementById('gpxInfo').innerText = totalD.toFixed(1) + " km";
            };
            reader.readAsText(file);
        };

        function haversine(la1, lo1, la2, lo2) {
            const R = 6371; const dLat = (la2 - la1) * Math.PI / 180; const dLon = (lo2 - lo1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function drawElev(data) {
            const ctx = document.getElementById('elevationChart').getContext('2d');
            if (elevChart) elevChart.destroy();
            elevChart = new Chart(ctx, {
                type: 'line', data: { datasets: [{ data, fill: true, borderColor: '#888', backgroundColor: 'rgba(200,200,200,0.3)', pointRadius: 0, borderWidth: 1 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    scales: { x: { type: 'linear' }, y: { beginAtZero: false } }, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: { title: c => `ê±°ë¦¬: ${c[0].parsed.x} km`, label: c => `ê³ ë„: ${c.parsed.y} m` }
                        }
                    } 
                }
            });
        }

        // --- ZWO ë¶„ì„ ë° ìµœì í™” ë¡œì§ ---
        document.getElementById('zwoInput').onchange = function(e) {
            const file = e.target.files[0]; if (!file) return;
            fName = file.name;
            const reader = new FileReader();
            reader.onload = function(ev) {
                parsedSegs = parseZWO(ev.target.result);
                updateDisplay();
                document.getElementById('resultArea').style.display = 'block';
            };
            reader.readAsText(file);
        };

        function parseZWO(xmlText) {
            const xml = new DOMParser().parseFromString(xmlText, "text/xml");
            const workout = xml.getElementsByTagName("workout")[0];
            const segs = []; if (!workout) return [];
            for (let n of workout.children) {
                if (["SteadyState", "Warmup", "CoolDown", "Ramp", "IntervalsT"].includes(n.tagName)) {
                    if(n.tagName === "IntervalsT") {
                        let r = parseInt(n.getAttribute("Repeat"));
                        for(let i=0; i<r; i++) {
                            segs.push({ d: parseFloat(n.getAttribute("OnDuration")), pL: parseFloat(n.getAttribute("OnPower")), pH: parseFloat(n.getAttribute("OnPower")) });
                            segs.push({ d: parseFloat(n.getAttribute("OffDuration")), pL: parseFloat(n.getAttribute("OffPower")), pH: parseFloat(n.getAttribute("OffPower")) });
                        }
                    } else {
                        segs.push({ d: parseFloat(n.getAttribute("Duration")), pL: parseFloat(n.getAttribute("PowerLow") || n.getAttribute("Power")), pH: parseFloat(n.getAttribute("PowerHigh") || n.getAttribute("Power")) });
                    }
                }
            }
            return segs;
        }

        function updateDisplay() {
            const ftp = parseFloat(document.getElementById('ftpInput').value) || 200;
            const weight = parseFloat(document.getElementById('weightInput').value) || 70;
            let tSec = 0, aPSum = 0, nSum = 0;
            parsedSegs.forEach(s => {
                tSec += s.d; let avg = (s.pL + s.pH) / 2;
                aPSum += (avg * s.d); nSum += (Math.pow(avg, 4) * s.d);
            });
            const avgP = aPSum / tSec, np = Math.pow(nSum / tSec, 0.25);
            const h = Math.floor(tSec / 3600), m = Math.round((tSec % 3600) / 60);
            
            document.getElementById('resTime').innerText = `${h > 0 ? h + 'ì‹œê°„ ' : ''}${m}ë¶„`;
            document.getElementById('resNP').innerText = (np * ftp).toFixed(1) + " W";
            document.getElementById('resAvgP').innerText = (avgP * ftp).toFixed(1) + " W";
            document.getElementById('resIF').innerText = np.toFixed(2);
            document.getElementById('resTSS').innerText = Math.round((tSec * ftp * np * np) / (ftp * 36));
            document.getElementById('resWkg').innerText = ((avgP * ftp) / weight).toFixed(2);
            drawWork(ftp);
        }

        function drawWork(ftp) {
            const ctx = document.getElementById('workoutChart').getContext('2d');
            let pts = [], cur = 0;
            parsedSegs.forEach(s => {
                pts.push({ x: cur / 60, y: s.pL * ftp }); cur += s.d;
                pts.push({ x: cur / 60, y: s.pH * ftp });
            });
            if (workChart) workChart.destroy();
            workChart = new Chart(ctx, {
                type: 'line', data: { datasets: [{ data: pts, fill: true, pointRadius: 0, segment: { borderColor: c => getZC(c, ftp), backgroundColor: c => getZC(c, ftp, 0.3) }, borderWidth: 2 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    scales: { 
                        x: { 
                            type: 'linear', 
                            ticks: { callback: v => { const h=Math.floor(v/60), m=Math.floor(v%60); return (h>0?h+':':'')+(m<10?'0':'')+m; } } 
                        }, 
                        y: { beginAtZero: true, ticks: { callback: v => v+' W' } } 
                    }, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: { title: c => { const v=c[0].parsed.x, h=Math.floor(v/60), m=Math.floor(v%60); return `ì‹œê°„: ${(h>0?h+':':'')+(m<10?'0':'')+m}`; }, label: c => `íŒŒì›Œ: ${Math.round(c.parsed.y)} W` }
                        }
                    } 
                }
            });
        }

        function getZC(c, ftp, a = 1) {
            if(!c.p0) return `rgba(200,200,200,${a})`;
            const p = c.p0.parsed.y / ftp;
            if (p < 0.60) return `rgba(150,150,150,${a})`;
            if (p < 0.76) return `rgba(52,152,219,${a})`;
            if (p < 0.90) return `rgba(46,204,113,${a})`;
            if (p < 1.05) return `rgba(241,196,15,${a})`;
            if (p < 1.19) return `rgba(230,126,34,${a})`;
            return `rgba(231,76,60,${a})`;
        }

        function copyT(id) {
            navigator.clipboard.writeText(document.getElementById(id).innerText);
            alert("ê²½ë¡œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! íƒìƒ‰ê¸° ì£¼ì†Œì°½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.");
        }

        function openModal() { document.getElementById('gModal').style.display = 'block'; }
        function closeModal() { document.getElementById('gModal').style.display = 'none'; }

        function openDeployGuideModal() { document.getElementById('deployGuideModal').style.display = 'block'; }
        function closeDeployGuideModal() { document.getElementById('deployGuideModal').style.display = 'none'; }

        document.getElementById('downloadBtn').onclick = function() {
            let xml = `<?xml version="1.0" encoding="UTF-8"?><workout_file><name>Opt_${fName.replace('.zwo','')}</name><workout>`;
            parsedSegs.forEach(s => { xml += `<SteadyState Duration="${s.d}" Power="${s.pH}"/>`; });
            xml += `</workout></workout_file>`;
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([xml], {type: "text/xml"}));
            a.download = "Optimized_" + fName; a.click();
        };

        // ì´ˆê¸° ë¡œë“œ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
        if(localStorage.getItem('zwo_ftp')) document.getElementById('ftpInput').value = localStorage.getItem('zwo_ftp');
        if(localStorage.getItem('zwo_weight')) document.getElementById('weightInput').value = localStorage.getItem('zwo_weight');

        document.getElementById('ftpInput').oninput = function() {
            localStorage.setItem('zwo_ftp', this.value);
            updateDisplay();
        };
        document.getElementById('weightInput').oninput = function() {
            localStorage.setItem('zwo_weight', this.value);
            updateDisplay();
        };

    </script>
</body>
</html>