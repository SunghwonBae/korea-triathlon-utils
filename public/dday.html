<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŠ¸ë¼ì´ì• ìŠ¬ë¡  D-Day ëŒ€ì‹œë³´ë“œ</title>
    <style>
        :root { --primary: #0070f3; --private-color: #28a745; --bg: #f4f4f5; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* ì…ë ¥ í¼ */
        .form-box { background: white; padding: 20px; border-radius: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .full { grid-column: 1 / -1; }
        label { font-size: 12px; font-weight: bold; color: #666; display: block; margin-bottom: 5px; }
        input, select, button { padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        button.view-btn { background: #666; width: auto; margin-left: 5px; }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        .calendar-view { background: white; padding: 20px; border-radius: 10px; display: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #eee; gap: 1px; border: 1px solid #eee; }
        .cal-day { background: white; min-height: 80px; padding: 5px; position: relative; }
        .cal-header { background: #f8f9fa; text-align: center; padding: 10px; font-weight: bold; }
        .event-tag { font-size: 11px; padding: 2px 4px; border-radius: 3px; color: white; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .event-tag.public { background: var(--primary); }
        .event-tag.private { background: var(--private-color); }
        
        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .list-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card.public { border-left-color: var(--primary); }
        .card.private { border-left-color: var(--private-color); }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>ğŸŠâ€â™‚ï¸ ì¼ì • ëŒ€ì‹œë³´ë“œ</h1>
        <div>
            <button class="view-btn" onclick="toggleView('list')">ëª©ë¡í˜•</button>
            <button class="view-btn" onclick="toggleView('cal')">ë‹¬ë ¥í˜•</button>
        </div>
    </div>

    <div class="form-box">
        <div class="full"><label>ì¼ì • ì œëª©</label><input type="text" id="title" placeholder="ëŒ€íšŒëª… ë˜ëŠ” í›ˆë ¨ ë‚´ìš©"></div>
        <div><label>ì‹œì‘ì¼</label><input type="date" id="sDate"></div>
        <div><label>ì¢…ë£Œì¼(ì„ íƒ)</label><input type="date" id="eDate"></div>
        <div><label>ì‹œì‘ì‹œê°„</label><input type="time" id="sTime"></div>
        <div><label>ì¢…ë£Œì‹œê°„</label><input type="time" id="eTime"></div>
        <div><label>êµ¬ë¶„</label><select id="type"><option value="public">ê³µìœ  ì¼ì •</option><option value="private">ê°œì¸ ì¼ì •</option></select></div>
        <div class="full"><button onclick="saveEvent()">ì¼ì • ë“±ë¡í•˜ê¸°</button></div>
    </div>

    <div id="listView" class="list-view"></div>
    <div id="calView" class="calendar-view">
        <div id="monthTitle" style="text-align:center; font-weight:bold; margin-bottom:10px;"></div>
        <div class="calendar-grid" id="calGrid"></div>
    </div>
</div>

<script>
    let events = [];
    let viewDate = new Date();

    async function loadData() {
        // 1. Redisì—ì„œ ê³µìœ  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        let publicData = [];
        try {
            const res = await fetch('/api/ddays');
            publicData = await res.json();
        } catch(e) { console.error("Redis Load Fail", e); }

        // 2. LocalStorageì—ì„œ ê°œì¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const privateData = JSON.parse(localStorage.getItem('my_events') || '[]');
        
        events = [...publicData, ...privateData];
        render();
    }

    async function saveEvent() {
        const payload = {
            title: document.getElementById('title').value,
            startDate: document.getElementById('sDate').value,
            endDate: document.getElementById('eDate').value || document.getElementById('sDate').value,
            startTime: document.getElementById('sTime').value,
            endTime: document.getElementById('eTime').value,
            type: document.getElementById('type').value
        };

        if(!payload.title || !payload.startDate) return alert("í•„ìˆ˜ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.");

        if(payload.type === 'public') {
            await fetch('/api/ddays', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
        } else {
            const privates = JSON.parse(localStorage.getItem('my_events') || '[]');
            privates.push({...payload, id: Date.now().toString()});
            localStorage.setItem('my_events', JSON.stringify(privates));
        }

        location.reload();
    }

    function render() {
        renderList();
        renderCal();
    }

    function renderList() {
        const list = document.getElementById('listView');
        list.innerHTML = '';
        events.sort((a,b) => new Date(a.startDate) - new Date(b.startDate))
              .forEach(e => {
            const dday = Math.ceil((new Date(e.startDate).setHours(0,0,0,0) - new Date().setHours(0,0,0,0)-1) / (1000*60*60*24));
            const dText = dday === 0 ? "D-Day" : (dday > 0 ? `D-${dday}` : `D+${Math.abs(dday)}`);
            list.innerHTML += `
                <div class="card ${e.type}">
                    <div style="font-weight:bold; color:var(--primary)">${dText}</div>
                    <div style="font-size:18px; margin:5px 0;">${e.title}</div>
                    <div style="font-size:12px; color:#666;">ğŸ“… ${e.startDate} ${e.endDate !== e.startDate ? '~ ' + e.endDate : ''}</div>
                    ${e.startTime ? `<div style="font-size:12px; color:#888;">â° ${e.startTime} ${e.endTime ? '~ ' + e.endTime : ''}</div>` : ''}
                </div>`;
        });
    }

    function renderCal() {
        const grid = document.getElementById('calGrid');
        grid.innerHTML = '';
        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();
        document.getElementById('monthTitle').innerText = `${y}ë…„ ${m+1}ì›”`;

        ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => grid.innerHTML += `<div class="cal-header">${d}</div>`);

        const first = new Date(y, m, 1).getDay();
        const last = new Date(y, m+1, 0).getDate();

        for(let i=0; i<first; i++) grid.innerHTML += `<div class="cal-day"></div>`;

        for(let d=1; d<=last; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayEvents = events.filter(e => dateStr >= e.startDate && dateStr <= e.endDate);
            
            let html = `<div class="cal-day"><strong>${d}</strong>`;
            dayEvents.forEach(e => {
                html += `<div class="event-tag ${e.type}">${e.title}</div>`;
            });
            html += `</div>`;
            grid.innerHTML += html;
        }
    }

    function toggleView(v) {
        document.getElementById('listView').style.display = v === 'list' ? 'grid' : 'none';
        document.getElementById('calView').style.display = v === 'cal' ? 'block' : 'none';
    }

    loadData();
</script>
</body>
</html>