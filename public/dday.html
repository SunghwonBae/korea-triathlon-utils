<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï≤†Ïù∏3Ï¢Ö ÌÜµÌï© Ï∫òÎ¶∞Îçî</title>
    <style>
        :root { --primary: #0070f3; --private: #ff9800; }
        body { font-family: sans-serif; margin: 0; padding: 15px; background: #f8f9fa; }
        .section { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* Îã¨Î†• Ìó§Îçî */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-header button { padding: 5px 15px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 5px; }
        
        /* Îã¨Î†• Í∑∏Î¶¨Îìú */
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid #eee; border-left: 1px solid #eee; }
        .day { min-height: 80px; padding: 5px; border-right: 1px solid #eee; border-bottom: 1px solid #eee; font-size: 12px; }
        .day.header { font-weight: bold; background: #fdfdfd; min-height: auto; text-align: center; }
        .day.today { background: #eef6ff; }
        .ev-item { font-size: 10px; margin-top: 2px; padding: 2px; border-radius: 3px; color: white; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .ev-item.public { background: var(--primary); }
        .ev-item.private { background: var(--private); }

        /* ÏûÖÎ†• Ìèº */
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .add-btn { padding: 10px; background: var(--private); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* Î¶¨Ïä§Ìä∏ Î≥¥Í∏∞ */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .del-btn { color: #ff4d4f; border: none; background: none; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

    <div class="section">
        <h4 style="margin:0 0 10px 0">üß° ÎÇ¥ ÏùºÏ†ï Ï∂îÍ∞Ä (Î°úÏª¨ Ï†ÄÏû•)</h4>
        <div class="input-group">
            <input type="text" id="title" placeholder="ÏùºÏ†ï Ï†úÎ™©">
            <input type="date" id="date">
            <button class="add-btn" onclick="addPrivate()">Ï†ÄÏû•</button>
        </div>
    </div>

    <div class="section">
        <div class="cal-header">
            <button onclick="changeMonth(-1)">‚óÄ Ïù¥Ï†ÑÎã¨</button>
            <h3 id="currentMonthStr">2026. 01</h3>
            <button onclick="changeMonth(1)">Îã§ÏùåÎã¨ ‚ñ∂</button>
        </div>
        <div id="calendarGrid" class="calendar"></div>
    </div>

    <div class="section">
        <h4>üìã Ï†ÑÏ≤¥ ÏùºÏ†ï Î¶¨Ïä§Ìä∏</h4>
        <div id="listView"></div>
    </div>

    <script>
        let currentViewDate = new Date();
        const STORAGE_KEY = 'my_private_ddays';

        // 1. Í∞úÏù∏ ÏùºÏ†ï Ï†ÄÏû• (Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ)
        function addPrivate() {
            const title = document.getElementById('title').value;
            const startDate = document.getElementById('date').value;
            if(!title || !startDate) return alert("ÏûÖÎ†• ÌïÑÏàò!");
            const prev = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            localStorage.setItem(STORAGE_KEY, JSON.stringify([...prev, { id: 'local-'+Date.now(), title, startDate, type:'private' }]));
            init();
        }

        // 2. ÌÜµÌï© Î°úÎìú Î∞è Ï¥àÍ∏∞Ìôî
        async function init() {
            const res = await fetch('/api/ddays');
            const publicData = await res.json();
            const privateData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const allData = [...publicData, ...privateData];
            
            renderCalendar(allData);
            renderList(allData);
        }

        // 3. Îã¨Î†• Î†åÎçîÎßÅ
        function renderCalendar(events) {
            const grid = document.getElementById('calendarGrid');
            const monthStr = document.getElementById('currentMonthStr');
            grid.innerHTML = '';
            
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            monthStr.innerText = `${year}. ${String(month + 1).padStart(2, '0')}`;

            ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'].forEach(d => grid.innerHTML += `<div class="day header">${d}</div>`);

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="day"></div>`;

            for(let d=1; d<=lastDate; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayEvents = events.filter(e => e.startDate.startsWith(dateStr));
                let evHtml = dayEvents.map(e => `<div class="ev-item ${e.type}">${e.title}</div>`).join('');
                grid.innerHTML += `<div class="day">${d}${evHtml}</div>`;
            }
        }

        // 4. Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ Î∞è ÏÇ≠Ï†ú
        function renderList(events) {
            const listView = document.getElementById('listView');
            listView.innerHTML = '';
            events.sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
            events.forEach(e => {
                listView.innerHTML += `
                    <div class="list-item">
                        <span>[${e.startDate}] ${e.title}</span>
                        <button class="del-btn" onclick="handleDelete('${e.id}', '${e.type}')">ÏÇ≠Ï†ú</button>
                    </div>`;
            });
        }

        async function handleDelete(id, type) {
            if(!confirm('ÏÇ≠Ï†úÌï†ÍπåÏöî?')) return;
            if(type === 'private') {
                const filtered = JSON.parse(localStorage.getItem(STORAGE_KEY)).filter(e => e.id !== id);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
            } else {
                await fetch(`/api/ddays?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
            }
            init();
        }

        function changeMonth(val) {
            currentViewDate.setMonth(currentViewDate.getMonth() + val);
            init();
        }

        init();
    </script>
</body>
</html>