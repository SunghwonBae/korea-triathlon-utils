<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-Memory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="menu_full_handler.js" defer></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #1e293b; }
        :root {
            --primary-blue: #0A317E;  
            --border-light: #eee;
            --text-dark: #333;
            --white: #ffffff;
        }
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; }
                /* 슬라이드 메뉴 스타일 */
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9998; opacity: 0; visibility: hidden; transition: 0.3s; }
        .menu-overlay.is-active { opacity: 1; visibility: visible; }
        .slide-menu { position: fixed; top: 0; left: -300px; width: 300px; height: 100%; background: white; z-index: 9999; transition: 0.3s; box-shadow: 2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; }
        .slide-menu.is-active { left: 0; }
        .menu-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; color: white; background-color: var(--primary-blue); /* 기존 테마 색상 */ }
        .menu-header h2 { font-size: 1.2rem; font-weight: bold; margin: 0; }
        .menu-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .menu-list { list-style: none; padding: 0; margin: 0; }
        .menu-link { display: block; padding: 15px 20px; text-decoration: none; color: #333; font-weight: 500; border-bottom: 1px solid #f8f9fa; transition: 0.2s; }
        .menu-link:hover { background: #f8f9fa; color: #dc2626; }
        .submenu-list .menu-link { padding-left: 40px; font-size: 0.95rem; background: #fcfcfc; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #ef4444; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 모바일 세로모드 최적화 */
        @media (max-width: 768px) {
            body { padding: 1rem !important; }
            header { flex-direction: column; align-items: flex-start; gap: 1.5rem; margin-bottom: 1.5rem !important; }
            header > div:first-child { width: 100%; padding-top: 0; } 
            header > div:first-child > h1 { padding-left: 3.5rem; } /* 메뉴 버튼 공간 확보 */
            header > div:first-child > p { padding-left: 3.5rem; } /* 메뉴 버튼 공간 확보 */
            header > div:last-child { width: 100%; }
            h1.text-3xl { font-size: 1.75rem !important; line-height: 1.2; }
            h2.text-2xl { font-size: 1.2rem !important; }
            .text-sm { font-size: 0.8rem !important; }
            table th, table td { padding: 0.75rem 0.25rem !important; font-size: 0.75rem !important; }
            .slide-menu { width: 85% !important; left: -85% !important; }
            .slide-menu.is-active { left: 0 !important; }
            #menuToggle { top: 1rem !important; left: 1rem !important; }
            /* 탭바 모바일 최적화 */
            nav { padding-left: 0.25rem !important; padding-right: 0.25rem !important; justify-content: space-between; overflow-x: hidden !important; }
            .tab-btn { padding: 1rem 0.1rem !important; font-size: 0.75rem !important; letter-spacing: -0.5px !important; flex: 1; }
        }
    </style>
</head>
<body class="p-6 md:p-10">
    <div class="max-w-5xl mx-auto">
        <input type="file" id="importInput" accept=".json" class="hidden" onchange="importData(event)">
        <button id="menuToggle" class="absolute left-6 top-6 z-50 bg-white border border-slate-300 rounded-lg w-10 h-10 flex justify-center items-center text-xl text-blue-900 shadow-md hover:bg-slate-50 transition-all"><i class="fas fa-bars"></i></button>
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter text-slate-900 uppercase">
                    <span class="text-blue-600">T-Memory</span> 바구니
                </h1>
                <p class="text-slate-400 font-bold text-sm mt-1 uppercase tracking-widest">트라이애슬론 메모리에 저장된 데이터 관리</p>
                <div class="mt-5 bg-white p-5 rounded-2xl border border-slate-200 shadow-sm text-xs text-slate-500 leading-relaxed max-w-2xl">
                    <p class="flex items-start gap-2 mb-2">
                        <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                        <span>이 데이터는 사용자 브라우저의 <b class="text-slate-700">로컬스토리지</b>에 저장됩니다. 브라우저 캐시 삭제 시 데이터가 삭제될 수 있습니다. <br>중요한 데이터는 <b class="text-slate-700">Export</b> 버튼으로 백업(JSON)하고, 필요 시 <b class="text-slate-700">Import</b>로 복구할 수 있습니다.</span>
                    </p>
                    <p class="flex items-start gap-2">
                        <i class="fas fa-arrows-alt-v text-blue-500 mt-0.5"></i>
                        <span>코스별 테이블 안에서 <b class="text-slate-700">드래그 앤 드롭</b>으로 순서를 변경할 수 있습니다.</span>
                    </p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="clearAll()" class="bg-red-100 text-red-600 px-5 py-3 rounded-xl font-bold text-sm hover:bg-red-200 transition-colors">
                    <i class="fas fa-trash-alt mr-2"></i>전체 삭제
                </button>
                <a href="/memory_report.html" class="bg-blue-100 text-blue-600 px-5 py-3 rounded-xl font-bold text-sm hover:bg-blue-200 transition-colors flex items-center justify-center" title="분석 리포트 열기">
                    <i class="fas fa-chart-line mr-2"></i>분석 레포트
                </a>
                <button onclick="triggerImport()" class="bg-slate-100 text-slate-600 px-4 py-3 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors">
                    <i class="fas fa-file-import mr-2"></i>Import
                </button>
                <button onclick="exportData()" class="bg-slate-100 text-slate-600 px-4 py-3 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors">
                    <i class="fas fa-file-export mr-2"></i>Export
                </button>
            </div>
        </header>

        <div class="max-w-lg mx-auto mb-8">
            <div class="relative flex items-center gap-2">
                <button id="multiSearchToggle" onclick="toggleMultiSearch()" class="flex-shrink-0 w-12 h-12 rounded-xl border border-slate-300 bg-white text-slate-400 hover:text-blue-600 hover:border-blue-500 transition-all shadow-sm flex items-center justify-center text-xl" title="다중 검색 모드 (결과 누적)">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="relative flex-grow">
                    <input type="text" id="searchInput" 
                        class="w-full p-4 pl-12 rounded-full border border-slate-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                        placeholder="이름 (홍길동, Hong) 또는 배번호 또는 클럽명 검색...">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400 text-xl"></i>
                </div>
            </div>
            <div id="searchTagsArea" class="flex flex-wrap gap-2 mt-3 empty:hidden"></div>
            <p class="text-xs text-slate-400 mt-2 ml-1">
                <i class="fas fa-info-circle mr-1"></i> + 버튼을 켜면 검색 결과가 누적됩니다. (검색어 입력 후 Enter, 최대 10개) <br><span class="ml-2 text-red-400 font-bold">* 검색결과는 최대 500건으로 제한됩니다.</span>
            </p>
        </div>

        <nav class="flex border-b border-slate-200 mb-8 bg-white rounded-t-2xl px-4 overflow-x-auto">
            <button onclick="switchTab('Search')" id="tab-Search" class="tab-btn py-4 px-6 font-black text-sm uppercase tracking-wider transition-all">Search<span class="hidden md:inline"> Result</span></button>
            <button onclick="switchTab('Olympic')" id="tab-Olympic" class="tab-btn py-4 px-6 font-black text-sm uppercase tracking-wider transition-all">Olympic</button>
            <button onclick="switchTab('Half')" id="tab-Half" class="tab-btn py-4 px-6 font-black text-sm uppercase tracking-wider transition-all">Half</button>
            <button onclick="switchTab('Ironman')" id="tab-Ironman" class="tab-btn py-4 px-6 font-black text-sm uppercase tracking-wider transition-all">Ironman</button>
        </nav>

        <div id="emptyState" class="hidden p-10 text-center text-slate-400 bg-white rounded-3xl shadow-lg border border-slate-200">
            <i class="fas fa-box-open text-5xl mb-4 text-slate-200"></i>
            <p>저장된 데이터가 없습니다.</p>
        </div>

        <div id="tablesContainer" class="space-y-12">
            <!-- Tables will be injected here -->
        </div>
    </div>

    <script>
        const sToHms = (s) => { 
            if(s<=0) return "--:--:--"; 
            const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60); 
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; 
        };
        const sToMs = (s) => { if(s<=0) return "00:00"; const m=Math.floor(s/60), sec=Math.floor(s%60); return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; };

        function showToast(msg) {
            const el = document.createElement('div');
            el.className = 'fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800/90 text-white px-6 py-3 rounded-full shadow-2xl z-[9999] transition-all duration-300 opacity-0 font-bold text-sm backdrop-blur-sm transform translate-y-4';
            el.innerText = msg;
            document.body.appendChild(el);
            requestAnimationFrame(() => el.classList.remove('opacity-0', 'translate-y-4'));
            setTimeout(() => {
                el.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        let currentTab = 'Search';
        let allData = [];
        let currentSearchResults = [];
        let isMultiSearchMode = false;
        let searchTags = [];
        const CHO_HANGUL = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];

        async function loadAllData() {
            try {
                const res = await fetch('/data/all_records.json');
                allData = await res.json();
            } catch (e) {
                console.error("데이터 로드 실패:", e);
            }
        }

        function getKoreanRegex(searchStr) {
            let regexStr = "";
            for (let char of searchStr) {
                if (/[가-힣]/.test(char)) {
                    regexStr += char;
                } else if (/[ㄱ-ㅎ]/.test(char)) {
                    const choIndex = CHO_HANGUL.indexOf(char);
                    if (choIndex > -1) {
                        const begin = 0xAC00 + (choIndex * 588);
                        const end = begin + 587;
                        regexStr += `[${char}\\u${begin.toString(16)}-\\u${end.toString(16)}]`;
                    } else {
                        regexStr += char;
                    }
                } else {
                    regexStr += char;
                }
            }
            return new RegExp(regexStr, 'i');
        }

        function switchTab(type) {
            currentTab = type;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`tab-${type}`).classList.add('tab-active');
            
            if (type === 'Search') {
                renderSearchResults();
            } else {
                loadMemory();
            }
        }

        function performSearch(val) {
            if (!val || val.length < 2) return [];
            const searchVal = val.toLowerCase().replace(/\s/g, '');
            const regex = getKoreanRegex(val);
            
            const results = [];
            for (let i = 0; i < allData.length; i++) {
                const item = allData[i];
                if ((item.searchKey && item.searchKey.includes(searchVal)) ||
                    regex.test(item.n) ||
                    (item.n && item.n.toLowerCase().includes(val.toLowerCase())) ||
                    (item.c && item.c.toLowerCase().includes(val.toLowerCase()))) {
                    results.push(item);
                    if (results.length >= 500) break;
                }
            }
            return results;
        }

        function toggleMultiSearch() {
            isMultiSearchMode = !isMultiSearchMode;
            const btn = document.getElementById('multiSearchToggle');
            const input = document.getElementById('searchInput');
            
            if (isMultiSearchMode) {
                btn.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-600');
                btn.classList.remove('bg-white', 'text-slate-400');
                if (input.value.trim().length >= 2) {
                    addSearchTag(input.value.trim());
                    input.value = '';
                }
            } else {
                btn.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-600');
                btn.classList.add('bg-white', 'text-slate-400');
                searchTags = [];
                updateSearchTagsUI();
                renderSearchResults(); 
            }
        }

        function addSearchTag(keyword) {
            if (searchTags.length >= 10) {
                showToast('최대 10개까지만 추가할 수 있습니다.');
                return;
            }
            if (searchTags.some(t => t.keyword === keyword)) {
                showToast('이미 추가된 검색어입니다.');
                return;
            }

            const results = performSearch(keyword);
            
            if (results.length === 0) {
                showToast('검색 결과가 없습니다.');
                return;
            }

            searchTags.push({ keyword, count: results.length, results });
            updateSearchTagsUI();
            renderMultiSearchResults();
        }

        function removeSearchTag(idx) {
            searchTags.splice(idx, 1);
            updateSearchTagsUI();
            renderMultiSearchResults();
        }

        function updateSearchTagsUI() {
            const area = document.getElementById('searchTagsArea');
            area.innerHTML = searchTags.map((tag, idx) => `
                <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2 animate-pulse-once">
                    ${tag.keyword} <span class="bg-white text-blue-600 px-1.5 rounded-md text-[10px]">${tag.count}</span>
                    <button onclick="removeSearchTag(${idx})" class="hover:text-blue-900"><i class="fas fa-times"></i></button>
                </span>
            `).join('');
        }

        function renderMultiSearchResults() {
            let combined = [];
            const seen = new Set();
            
            searchTags.forEach(tag => {
                tag.results.forEach(item => {
                    const key = (item.raceName || '') + '_' + item.b;
                    if (!seen.has(key)) {
                        seen.add(key);
                        combined.push(item);
                    }
                });
            });
            
            currentSearchResults = combined;
            renderTable(combined, 'Search');
        }

        function renderSearchResults() {
            if (isMultiSearchMode) return;

            const val = document.getElementById('searchInput').value.trim();
            const container = document.getElementById('tablesContainer');
            const emptyState = document.getElementById('emptyState');
            
            emptyState.classList.add('hidden');
            container.innerHTML = '';

            if (val.length < 2) {
                container.innerHTML = `<div class="p-20 text-center text-slate-400 bg-white rounded-3xl shadow-lg border border-slate-200">
                    <i class="fas fa-search text-5xl mb-4 text-slate-200"></i>
                    <p class="font-medium">검색어를 2글자 이상 입력하세요.</p>
                </div>`;
                return;
            }

            const filtered = performSearch(val);

            currentSearchResults = filtered;
            renderTable(filtered, 'Search');
        }

        function loadMemory() {
            const memory = JSON.parse(localStorage.getItem('triathlon_memory') || '[]');
            const emptyState = document.getElementById('emptyState');
            const container = document.getElementById('tablesContainer');

            if (memory.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            const type = currentTab;
            const items = memory.filter(m => (m.raceType || 'Olympic') === type).sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

            renderTable(items, type);
        }

        function renderTable(items, type) {
            const container = document.getElementById('tablesContainer');
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = `<div class="p-20 text-center text-slate-400 bg-white rounded-3xl shadow-lg border border-slate-200">
                    <i class="fas fa-${type === 'Search' ? 'search' : 'folder-open'} text-5xl mb-4 text-slate-200"></i>
                    <p class="font-medium">${type === 'Search' ? '검색 결과가 없습니다.' : type + ' 코스에 저장된 데이터가 없습니다.'}</p>
                </div>`;
                return;
            }

            const memory = JSON.parse(localStorage.getItem('triathlon_memory') || '[]');
            
            let actionHeader = 'Action';
            if (type === 'Search') {
                actionHeader = `<button onclick="saveAllSearchResults()" class="bg-blue-600 text-white px-2 py-1 rounded text-[11px] hover:bg-blue-700 transition-colors shadow-sm whitespace-nowrap">전체저장</button>`;
            }

            const section = document.createElement('div');
            section.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-slate-800 flex items-center">
                        <i class="fas fa-layer-group mr-2 text-blue-600"></i>${type === 'Search' ? '검색 결과' : type + ' 코스'}
                        <span class="ml-3 text-sm font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-lg">${items.length} 건</span>
                    </h2>
                    <button onclick="exportToCSV('${type}')" title="CSV 다운로드" class="hover:opacity-80 transition-opacity"><img src="xlsdown.png" alt="Download CSV" style="width: 30px; height: 30px; display: block;"></button>
                </div>
                <div class="bg-white rounded-3xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase text-xs font-black tracking-wider">
                                    <th class="py-3 px-4">Year</th>
                                    <th class="py-3 px-4">Race</th>
                                    <th class="py-3 px-4">Bib</th>
                                    <th class="py-3 px-4">Name</th>
                                    <th class="py-3 px-4 hidden md:table-cell">Div</th>
                                    <th class="py-3 px-4">Swim</th>
                                    <th class="py-3 px-4 hidden md:table-cell">T1</th>
                                    <th class="py-3 px-4">Bike</th>
                                    <th class="py-3 px-4 hidden md:table-cell">T2</th>
                                    <th class="py-3 px-4">Run</th>
                                    <th class="py-3 px-4">Total</th>
                                    <th class="py-3 px-4 text-center">${actionHeader}</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-${type}" class="divide-y divide-slate-100 font-bold text-slate-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            container.appendChild(section);

            const tbody = section.querySelector(`#tbody-${type}`);
            items.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors select-none group " + (type !== 'Search' ? "cursor-move" : "");
                if (type !== 'Search') {
                    tr.draggable = true;
                    // Drag Events
                    tr.ondragstart = handleDragStart;
                    tr.ondragover = handleDragOver;
                    tr.ondrop = handleDrop;
                }
                tr.dataset.type = type;
                tr.dataset.index = idx;
                

                // 대회명 정제: 연도(4자리 숫자)와 'half' 단어 제거
                let cleanRaceName = (item.raceName || '').replace(/[0-9]{4}/g, '').trim();

                // Action Button Logic
                let actionBtn = '';
                if (type === 'Search') {
                    const isSaved = memory.some(m => m.raceName === item.raceName && m.b === item.b);
                    if (isSaved) {
                        actionBtn = `<button class="text-slate-300 cursor-not-allowed p-1" title="이미 저장됨"><i class="fas fa-check"></i></button>`;
                    } else {
                        // item 객체를 문자열로 변환할 때 따옴표 처리 주의
                        const itemStr = JSON.stringify(item).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                        actionBtn = `<button onclick='addToMemory(${itemStr})' class="text-blue-500 hover:text-blue-700 transition-colors p-1" title="추가"><i class="fas fa-plus-circle"></i></button>`;
                    }
                } else {
                    cleanRaceName = cleanRaceName.replace(/half/gi, '').trim();
                    actionBtn = `<button onclick="deleteItem('${item.savedAt}')" class="text-slate-400 hover:text-red-600 transition-colors p-1"><i class="fas fa-trash-alt"></i></button>`;
                }

                tr.innerHTML = `
                    <td class="py-3 px-4 text-slate-500 font-mono text-xs">${item.raceYear || '-'}</td>
                    <td class="py-3 px-4 text-slate-800 text-xs whitespace-nowrap overflow-hidden text-ellipsis max-w-[80px] md:max-w-[150px]" title="${item.raceName}">${cleanRaceName}</td>
                    <td class="py-3 px-4 font-mono text-slate-500 text-xs">#${item.b}</td>
                    <td class="py-3 px-4 text-sm text-slate-900 font-bold">${item.n}</td>
                    <td class="py-3 px-4 text-[10px] uppercase text-slate-500 tracking-tight hidden md:table-cell">${item.d}</td>
                    <td class="py-3 px-4 text-xs text-blue-500 font-mono">${sToHms(item.s)}</td>
                    <td class="py-3 px-4 text-[10px] text-slate-400 font-mono hidden md:table-cell">${sToMs(item.t1)}</td>
                    <td class="py-3 px-4 text-xs text-green-500 font-mono">${sToHms(item.bk)}</td>
                    <td class="py-3 px-4 text-[10px] text-slate-400 font-mono hidden md:table-cell">${sToMs(item.t2)}</td>
                    <td class="py-3 px-4 text-xs text-orange-500 font-mono">${sToHms(item.rn)}</td>
                    <td class="py-3 px-4 font-black text-slate-900 font-mono text-sm">${sToHms(item.t)}</td>
                    <td class="py-3 px-4 text-center">
                        ${actionBtn}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function addToMemory(item) {
            let memory = JSON.parse(localStorage.getItem('triathlon_memory') || '[]');
            
            const normalize = (s) => (s || '').replace(/[_\-\s]/g, '').toUpperCase();

            // 중복 체크
            if (memory.some(m => normalize(m.raceName) === normalize(item.raceName) && m.b === item.b)) {
                showToast("이미 저장된 데이터입니다.");
                return;
            }

            const sameTypeItems = memory.filter(m => m.raceType === item.raceType);
            const maxOrder = sameTypeItems.length > 0 ? Math.max(...sameTypeItems.map(m => m.sortOrder || 0)) : 0;
            
            const memoryItem = {
                ...item,
                sortOrder: maxOrder + 1,
                savedAt: new Date().toISOString()
            };

            memory.push(memoryItem);
            localStorage.setItem('triathlon_memory', JSON.stringify(memory));
            
            // 현재 검색 결과 탭 갱신 (버튼 상태 업데이트를 위해)
            renderSearchResults();
        }

        function exportToCSV(type) {
            let items = [];
            if (type === 'Search') {
                items = currentSearchResults;
            } else {
                const memory = JSON.parse(localStorage.getItem('triathlon_memory') || '[]');
                items = memory.filter(m => (m.raceType || 'Olympic') === type).sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
            }

            if (items.length === 0) {
                showToast('내보낼 데이터가 없습니다.');
                return;
            }

            let csvContent = "\uFEFF"; // BOM for Excel
            csvContent += "Year,Race Name,Bib,Name,Div,Swim,T1,Bike,T2,Run,Total\n";

            items.forEach(item => {
                const row = [
                    item.raceYear || '',
                    (item.raceName || '').replace(/,/g, ' '),
                    item.b,
                    item.n,
                    item.d,
                    sToHms(item.s),
                    sToMs(item.t1),
                    sToHms(item.bk),
                    sToMs(item.t2),
                    sToHms(item.rn),
                    sToHms(item.t)
                ];
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `triathlon_memory_${type}_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function saveAllSearchResults() {
            if (!currentSearchResults || currentSearchResults.length === 0) {
                showToast("저장할 검색 결과가 없습니다.");
                return;
            }

            let memory = JSON.parse(localStorage.getItem('triathlon_memory') || '[]');
            let addedCount = 0;

            const normalize = (s) => (s || '').replace(/[_\-\s]/g, '').toUpperCase();

            currentSearchResults.forEach(item => {
                if (!memory.some(m => normalize(m.raceName) === normalize(item.raceName) && m.b === item.b)) {
                    const sameTypeItems = memory.filter(m => m.raceType === item.raceType);
                    const maxOrder = sameTypeItems.length > 0 ? Math.max(...sameTypeItems.map(m => m.sortOrder || 0)) : 0;
                    
                    const memoryItem = { ...item, sortOrder: maxOrder + 1, savedAt: new Date().toISOString() + '-' + Math.random().toString(36).substr(2, 9) };
                    memory.push(memoryItem);
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                localStorage.setItem('triathlon_memory', JSON.stringify(memory));
                showToast(`${addedCount}건의 데이터가 T-Memory에 저장되었습니다.`);
                renderSearchResults();
            } else {
                showToast("모든 데이터가 이미 저장되어 있습니다.");
            }
        }

        let dragSrcEl = null;

        function handleDragStart(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); this.classList.add('opacity-50'); }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            const targetRow = this;
            if (dragSrcEl !== targetRow && dragSrcEl.dataset.type === targetRow.dataset.type) {
                reorderItems(dragSrcEl.dataset.type, parseInt(dragSrcEl.dataset.index), parseInt(targetRow.dataset.index));
            }
            dragSrcEl.classList.remove('opacity-50');
            return false;
        }

        function reorderItems(type, srcIdx, targetIdx) {
            let memory = JSON.parse(localStorage.getItem('triathlon_memory') || '[]');
            let typeItems = memory.filter(m => (m.raceType || 'Olympic') === type).sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
            let otherItems = memory.filter(m => (m.raceType || 'Olympic') !== type);
            
            const [movedItem] = typeItems.splice(srcIdx, 1);
            typeItems.splice(targetIdx, 0, movedItem);
            typeItems.forEach((item, index) => { item.sortOrder = index + 1; });
            
            localStorage.setItem('triathlon_memory', JSON.stringify([...otherItems, ...typeItems]));
            loadMemory();
        }

        function deleteItem(savedAt) {
            if(!confirm('정말 삭제하시겠습니까?')) return;
            let memory = JSON.parse(localStorage.getItem('triathlon_memory') || '[]');
            memory = memory.filter(m => m.savedAt !== savedAt);
            localStorage.setItem('triathlon_memory', JSON.stringify(memory));
            loadMemory();
        }

        function clearAll() {
            if(!confirm('모든 데이터를 삭제하시겠습니까?')) return;
            localStorage.removeItem('triathlon_memory');
            loadMemory();
        }

        function exportData() {
            const data = localStorage.getItem('triathlon_memory');
            if (!data || data === '[]') {
                showToast('내보낼 데이터가 없습니다.');
                return;
            }
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `triathlon_memory_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function triggerImport() {
            document.getElementById('importInput').click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!Array.isArray(imported)) throw new Error('잘못된 파일 형식입니다.');
                    
                    // 기존 데이터와 병합 (중복 제거: savedAt 기준)
                    const current = JSON.parse(localStorage.getItem('triathlon_memory') || '[]');
                    const currentIds = new Set(current.map(i => i.savedAt));
                    
                    let addedCount = 0;
                    imported.forEach(item => {
                        // savedAt이 없으면 생성 (구버전 데이터 호환)
                        if (!item.savedAt) item.savedAt = new Date().toISOString() + Math.random();
                        
                        if (!currentIds.has(item.savedAt)) {
                            current.push(item);
                            currentIds.add(item.savedAt);
                            addedCount++;
                        }
                    });
                    
                    localStorage.setItem('triathlon_memory', JSON.stringify(current));
                    loadMemory();
                    showToast(`${addedCount}개의 데이터가 복구되었습니다.`);
                } catch (err) {
                    showToast('오류: ' + err.message);
                }
                event.target.value = ''; // Reset input
            };
            reader.readAsText(file);
        }
        
        document.getElementById('searchInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && isMultiSearchMode) {
                e.preventDefault();
                const val = e.target.value.trim();
                if (val.length >= 2) {
                    addSearchTag(val);
                    e.target.value = '';
                } else {
                    showToast('검색어를 2글자 이상 입력하세요.');
                }
            }
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            if (currentTab !== 'Search') {
                switchTab('Search');
            } else {
                renderSearchResults();
            }
        });

        window.onload = () => { loadAllData(); switchTab('Search'); };
    </script>
</body>
</html>